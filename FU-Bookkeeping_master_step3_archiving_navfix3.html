<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FU-BOOKKEEPING (BAS) ‚Äì offline i webbl√§saren</title>
  <style>
    html{ font-size: clamp(14px, 1.05vw, 16px); }
    :root{ --bg:#0b0f14; --card:#111826; --muted:#94a3b8; --text:#e5e7eb; --line:#223044; --ok:#22c55e; --bad:#ef4444; --accent:#60a5fa; }
    *{ box-sizing:border-box; }
    *[hidden]{ display:none !important; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#0b0f14,#070a0f); color:var(--text); }
    /* Header/nav: force-disable any lingering backdrop-filter (it can break clicks in some setups) */
    header{
      position:relative;
      z-index:5;
      background:rgba(11,15,20,.98);
      border-bottom:1px solid var(--line);
      backdrop-filter:none !important;
      -webkit-backdrop-filter:none !important;
      transform:none !important;
    }
    header::before{ content:none !important; }
    header .wrap, header nav{ position:relative; z-index:10; }
    header nav{ pointer-events:auto !important; }
    .tab{ pointer-events:auto !important; }

    /* Extra safety: ensure nothing overlays the nav row */
    header nav *{ pointer-events:auto !important; }

    .wrap{ max-width:1400px; margin:0 auto; padding:clamp(10px, 1.2vw, 16px); }

    /* Layout with vertical navigation */
    .layout{ display:grid; grid-template-columns: 200px 1fr; gap:12px; align-items:start;  min-width:0; }
    .sidebar{ display:grid; gap:8px; padding:12px; border:1px solid var(--line); border-radius:16px; background:rgba(17,24,38,.90); box-shadow: 0 10px 30px rgba(0,0,0,.18);  position:relative; z-index:20; }
    .sidebar .tab{ width:100%; text-align:left; }
    .content{ min-width:0; overflow:hidden;  position:relative; z-index:1; }

    @media (max-width: 900px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ display:flex; flex-wrap:wrap; }
      .sidebar .tab{ width:auto; }
    }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    h1{ margin:0; font-size:18px; font-weight:700; }
    .pill{ font-size:12px; color:var(--muted); border:1px solid var(--line); padding:6px 10px; border-radius:999px; }
    /* Header year dropdown should look like a pill */
    select.pill{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      background:rgba(17,24,38,.85);
      color:var(--text);
      cursor:pointer;
      border:1px solid rgba(96,165,250,.45);
      padding:8px 34px 8px 12px;
      border-radius:999px;
      font-weight:700;
      min-width: 340px;
      max-width: 100%;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--text) 50%),
        linear-gradient(135deg, var(--text) 50%, transparent 50%);
      background-position: calc(100% - 14px) 55%, calc(100% - 9px) 55%;
      background-size:5px 5px, 5px 5px;
      background-repeat:no-repeat;
    }
    select.pill:focus{
      outline:none;
      border-color:rgba(96,165,250,.7);
      box-shadow:0 0 0 3px rgba(96,165,250,.12);
    }

    nav{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    button, input, select, textarea{ font:inherit; }
    .tab{ background:transparent; color:var(--muted); border:1px solid var(--line); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .tab.active{ color:var(--text); border-color:rgba(96,165,250,.7); box-shadow:0 0 0 3px rgba(96,165,250,.12); }
    main .wrap{ padding-top:18px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; min-width:0; }
    @media (min-width: 980px){ .grid.two{ grid-template-columns: minmax(0, 1.25fr) minmax(0, 1fr); } }
    .card{ isolation:isolate; overflow:hidden; background:rgba(17,24,38,.94); border:1px solid var(--line); border-radius:16px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25);  min-width:0; overflow:hidden; }
    .card h2{ margin:0 0 10px 0; font-size:14px; color:var(--muted); font-weight:700; letter-spacing:.02em; }
    .muted{ color:var(--muted); }
    .btn{ background:rgba(96,165,250,.15); border:1px solid rgba(96,165,250,.4); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer; }
    .btn.secondary{ background:transparent; border-color:var(--line); color:var(--text); }
    .btn.danger{ background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .field{ display:grid; gap:6px; }
    .field label{ font-size:12px; color:var(--muted); }
    input, select, textarea{ background:#0b1220; color:var(--text); border:1px solid var(--line); border-radius:12px; padding:10px 10px; outline:none; }
    input:focus, select:focus, textarea:focus{ border-color:rgba(96,165,250,.7); box-shadow:0 0 0 3px rgba(96,165,250,.12); }
    textarea{ min-height: 84px; resize: vertical; }
    table{ width:100%; border-collapse: collapse; }
    th, td{ border-bottom:1px solid rgba(34,48,68,.8); padding:8px 8px; text-align:left; vertical-align:top; }
    th{ font-size:12px; color:var(--muted); font-weight:700; }
    td{ font-size:13px; }
    .right{ text-align:right; }
    .status{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); }
    .status.ok{ color:var(--ok); border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.08); }
    .status.bad{ color:var(--bad); border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.08); }
    .list{ display:grid; gap:12px; }
    .item{ position:relative; overflow:hidden; padding:10px; border:1px solid var(--line); border-radius:14px; background:rgba(11,18,32,.92); }
    .item .top{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .item .title{ font-weight:700; }
    .item .meta{ font-size:12px; color:var(--muted); }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; font-size:12px; color:var(--muted); }
    .small{ font-size:12px; }

    /* SRU (locked option) */
    .lockbox{ border:1px dashed rgba(148,163,184,.5); border-radius:16px; padding:12px; background:rgba(11,18,32,.55); }
    .lockbox .row{ justify-content:space-between; align-items:center; }
    .badge.lock{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.35); color:var(--muted); background:rgba(148,163,184,.08);
    }
    .badge.lock b{ color:var(--text); }

    /* In-app toast (replaces browser alert for success messages) */
    .toast{
      position:fixed;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      z-index:9999;
      max-width:min(520px, calc(100vw - 24px));
      background:rgba(17,24,38,.98);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      text-align:center;
      font-size:13px;
    }

    /* In-app confirm modal (replaces browser confirm dialogs) */
    .modal-backdrop{
      position:fixed;
      inset:0;
      z-index:9998;
      background:rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
    }
    .modal{
      width:min(520px, calc(100vw - 24px));
      background:rgba(17,24,38,.98);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .modal .actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px; flex-wrap:wrap; }

  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1 id="companyName">FU-BOOKKEEPING</h1>
      <select class="pill" id="yearPillSelect" aria-label="Aktivt r√§kenskaps√•r"></select>
      <span class="pill" id="bootPill">JS: laddar‚Ä¶</span>
      <span class="pill">Lagring: localStorage (offline)</span>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="layout">
      <aside class="sidebar" aria-label="Navigation">
        <button type="button" class="tab active" data-tab="vouchers">Verifikationer</button>
        <button type="button" class="tab" data-tab="accounts">Kontoplan</button>
                        <button type="button" class="tab" data-tab="reports">Rapporter</button>
<button type="button" class="tab" data-tab="customers">Kunder</button>
        <button type="button" class="tab" data-tab="suppliers">Leverant√∂rer</button>
<button type="button" class="tab" data-tab="invoices">Fakturor</button>
<button type="button" class="tab" data-tab="sru">SRU / Deklaration</button>
        <button type="button" class="tab" data-tab="export">Import/Export</button>
        <button type="button" class="tab" data-tab="settings">Inst√§llningar</button>
      </aside>
      <div class="content">

    <!-- VERIFIKATIONER -->
    <section id="tab-vouchers">
      <div class="grid two">
        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>Ny verifikation</h2>
            <div class="row">
              <button class="btn secondary" id="btnFillExample">Fyll A76‚ÄìA79 (exempel)</button>
              <button class="btn" id="btnNewVoucher">Ny</button>
            </div>
          </div>

          <div class="grid" style="gap:10px;">
            <div class="row" style="gap:10px;">
              <div class="field" style="min-width:140px;">
                <label>Datum</label>
                <input id="vDate" type="date" />
              </div>
              <div class="field" style="min-width:90px;">
                <label>Serie</label>
                <input id="vSeries" type="text" value="A" maxlength="10" />
              </div>
              <div class="field" style="min-width:110px;">
                <label>Vernr</label>
                <input id="vNo" type="text" placeholder="Auto" />
              </div>
              <div class="field" style="min-width:160px; flex:1;">
                <label>Text</label>
                <input id="vText" type="text" placeholder="t.ex. Lagerjustering" />
              </div>
              <div class="field" style="min-width:140px;">
                <label>Sign</label>
                <input id="vSign" type="text" placeholder="t.ex. MA" />
              </div>
            </div>

            <div class="card" style="padding:10px; border-radius:14px; background:rgba(11,18,32,.90);">
              <div class="row" style="justify-content:space-between; margin-bottom:8px;">
                <div class="muted small">Rader</div>
                <div class="row">
                  <span id="balanceBadge" class="status bad">Inte i balans</span>
                  <button class="btn secondary" id="btnAddLine">+ Rad</button>
                </div>
              </div>

              <div style="overflow:auto;">
                <table>
                  <thead>
                    <tr>
                      <th style="width:180px;">Konto</th>
                      <th>Radtext</th>
                      <th class="right" style="width:140px;">Debet</th>
                      <th class="right" style="width:140px;">Kredit</th>
                      <th style="width:70px;"></th>
                    </tr>
                  </thead>
                  <tbody id="linesTbody"></tbody>
                </table>
              </div>

              <div class="row" style="justify-content:space-between; margin-top:10px;">
                <div class="muted small">Tips: skriv 1460/1930 osv s√• filtreras listan.</div>
                <div class="row">
                  <button class="btn danger" id="btnClearVoucher">Rensa</button>
                  <button class="btn" id="btnSaveVoucher" disabled>Spara verifikation</button>
                </div>
              </div>
            </div>

            <div class="muted small">
              Balansregler: Summan debet ska vara lika med summan kredit. Programmet anv√§nder <span class="kbd">+ = debet</span> och <span class="kbd">‚àí = kredit</span> internt.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>Verifikationer i √•ret</h2>
            <div class="row">
              <select id="yearSelect"></select>
              <button class="btn secondary" id="btnRefresh">Uppdatera</button>
            </div>
          </div>

          <div id="voucherList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- KONTOPLAN -->
    <section id="tab-accounts" hidden>
      <div class="grid two">
        <div class="card">
          <h2>L√§gg till konto</h2>
          <div class="row" style="gap:10px;">
            <div class="field" style="min-width:140px;">
              <label>Konto</label>
              <input id="aNo" placeholder="t.ex. 1930" />
            </div>
            <div class="field" style="flex:1; min-width:220px;">
              <label>Namn</label>
              <input id="aName" placeholder="t.ex. F√∂retagskonto" />
            </div>
            <div class="field" style="min-width:180px;">
              <label>Typ (f√∂r rapporter)</label>
              <select id="aType">
                <option value="asset">Tillg√•ng (klass 1)</option>
                <option value="liability">Eget kapital/skuld (klass 2)</option>
                <option value="income">Int√§kt (klass 3)</option>
                <option value="expense">Kostnad (klass 4‚Äì8)</option>
                <option value="other">√ñvrigt</option>
              </select>
            </div>
            <button class="btn" id="btnAddAccount">L√§gg till</button>
          </div>
          <p class="muted small" style="margin:10px 0 0 0;">Du kan l√§gga exakt de konton du vill (BAS). Appen kommer inte stoppa dig fr√•n att anv√§nda ett konto √§ven om det √§r ‚Äùrubrik‚Äù ‚Äì men rapporter blir b√§ttre om du anv√§nder r√§tt underkonto (t.ex. 1460 i st√§llet f√∂r 1400).</p>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>Kontoplan</h2>
            <div class="row">
              <input id="accountSearch" placeholder="S√∂k (konto eller namn)" />
              <button class="btn danger" id="btnResetDemo">√Öterst√§ll demo-kontoplan</button>
              <button class="btn secondary" id="btnFixChars" title="F√∂rs√∂ker r√§tta vanliga teckenkodningsfel (√É¬•‚Üí√• osv).">Fixa √Ö√Ñ√ñ</button>
              <label class="btn secondary" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;" title="V√§lj en standardlista (CSV/JSON) f√∂r att auto-fixa konton som inneh√•ller \"ÔøΩ\".">
                Standardlista
                <input id="stdAccountsFile" type="file" accept=".json,.csv,.txt" hidden />
              </label>
            </div>
          </div>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th style="width:110px;">Konto</th>
                  <th>Namn</th>
                  <th style="width:170px;">Typ</th>
                  <th style="width:70px;"></th>
                </tr>
              </thead>
              <tbody id="accountsTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- RAPPORTER -->
    <section id="tab-reports" hidden>
      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>Rapportgenerator</h2>
            <div class="row">
              <button class="btn secondary" id="btnRptGenerate">Generera</button>
              <button class="btn" id="btnRptPrint" disabled>Skriv ut</button>
              <button class="btn secondary" id="btnRptCsv" disabled>CSV</button>
              <button class="btn secondary" id="btnRptXls" disabled>Excel</button>
            </div>
          </div>

          <div class="row" style="gap:10px; flex-wrap:wrap; align-items:flex-end; margin-bottom:10px;">
            <div class="field" style="min-width:260px;">
              <label>R√§kenskaps√•r</label>
              <select id="rptYearSelect"></select>
            </div>

            <div class="field" style="min-width:160px;">
              <label>Fr√•n</label>
              <input id="rptFrom" type="date" />
            </div>
            <div class="field" style="min-width:160px;">
              <label>Till</label>
              <input id="rptTo" type="date" />
            </div>

            <div class="field" style="min-width:260px; flex:1;">
              <label>Rapport</label>
              <select id="rptType">
                <option value="is">Resultatr√§kning (period)</option>
                <option value="bs">Balansr√§kning (per datum)</option>
                <option value="trial">Saldolista (period + ack)</option>
                <option value="gl">Huvudbok (period)</option>
                <option value="vj">Verifikationsjournal (period)</option>
              </select>
            </div>

            <button class="btn secondary" id="btnRptFullYear" type="button">Hela √•ret</button>
            <button class="btn secondary" id="btnRptThisMonth" type="button">Denna m√•nad</button>
            <button class="btn secondary" id="btnRptThisQuarter" type="button">Detta kvartal</button>
          </div>

          <div id="reportOutput" class="card" style="padding:12px; border-radius:14px; background:rgba(11,18,32,.90);">
            <div class="muted small">V√§lj rapport + datumintervall och klicka <b>Generera</b>.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- KUNDER -->
    <section id="tab-customers" hidden>
      <div class="grid two">
        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>Kundregister</h2>
            <div class="row">
              <button class="btn secondary" id="btnCustNew">Ny</button>
              <button class="btn" id="btnCustSave">Spara</button>
            </div>
          </div>

          <div class="grid" style="gap:10px;">
            <input type="hidden" id="custEditId" />
            <div class="field">
              <label>Namn</label>
              <input id="custRegName" placeholder="t.ex. Mariano Vozzi" />
            </div>
            <div class="field">
              <label>Adress</label>
              <input id="custRegAddr" placeholder="Gata, postnr, ort" />
            </div>
            <div class="row" style="gap:10px;">
              <div class="field" style="flex:1; min-width:220px;">
                <label>E-post (valfritt)</label>
                <input id="custRegEmail" placeholder="kund@exempel.se" />
              </div>
              <div class="field" style="min-width:180px;">
                <label>Org.nr (valfritt)</label>
                <input id="custRegOrgnr" placeholder="559999-9999" />
              </div>
            </div>
            <div class="muted small">Tips: kunder anv√§nds i Fakturor-fliken och sparas i din datafil/backup.</div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>Kunder</h2>
            <div class="row">
              <input id="custSearch" placeholder="S√∂k kund‚Ä¶" />
              <button class="btn secondary" id="btnCustRefresh">Uppdatera</button>
            </div>
          </div>
          <div id="customersList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- LEVERANT√ñRER -->
    <section id="tab-suppliers" hidden>
      <div class="grid two">
        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>Leverant√∂rsregister</h2>
            <div class="row">
              <button class="btn secondary" id="btnSupNew">Ny</button>
              <button class="btn" id="btnSupSave">Spara</button>
            </div>
          </div>

          <div class="grid" style="gap:10px;">
            <input type="hidden" id="supEditId" />
            <div class="field">
              <label>Namn</label>
              <input id="supRegName" placeholder="t.ex. Webhallen AB" />
            </div>
            <div class="field">
              <label>Adress</label>
              <input id="supRegAddr" placeholder="Gata, postnr, ort" />
            </div>
            <div class="row" style="gap:10px;">
              <div class="field" style="flex:1; min-width:220px;">
                <label>E-post (valfritt)</label>
                <input id="supRegEmail" placeholder="leverantor@exempel.se" />
              </div>
              <div class="field" style="min-width:180px;">
                <label>Org.nr (valfritt)</label>
                <input id="supRegOrgnr" placeholder="559999-9999" />
              </div>
            </div>
            <div class="row" style="gap:10px;">
              <div class="field" style="flex:1; min-width:220px;">
                <label>Bankgiro/Plusgiro (valfritt)</label>
                <input id="supRegPayout" placeholder="BG/PG" />
              </div>
            </div>
            <div class="muted small">Leverant√∂rer √§r f√∂rberett f√∂r kommande ink√∂p/leverant√∂rsfakturor.</div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>Leverant√∂rer</h2>
            <div class="row">
              <input id="supSearch" placeholder="S√∂k leverant√∂r‚Ä¶" />
              <button class="btn secondary" id="btnSupRefresh">Uppdatera</button>
            </div>
          </div>
          <div id="suppliersList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- FAKTUROR -->
    <section id="tab-invoices" hidden>
      <div class="grid two">
        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>Skapa faktura</h2>
            <div class="row">
              <button class="btn secondary" id="btnInvNew">Ny</button>
              <button class="btn" id="btnInvSave" disabled>Spara</button>
            </div>
          </div>

          <div class="grid" style="gap:10px;">
            <div class="row" style="gap:10px;">
              <div class="field" style="min-width:140px;">
                <label>Fakturadatum</label>
                <input id="invDate" type="date" />
              </div>
              <div class="field" style="min-width:140px;">
                <label>F√∂rfallodatum</label>
                <input id="invDue" type="date" />
              </div>
              <div class="field" style="min-width:110px;">
                <label>Nr</label>
                <input id="invNo" placeholder="Auto" />
              </div>
              <div class="field" style="flex:1; min-width:220px;">
                <label>Referens</label>
                <input id="invRef" placeholder="t.ex. Order 123" />
              </div>
            </div>

            <div class="card" style="padding:10px; border-radius:14px; background:rgba(11,18,32,.90);">
              <div class="row" style="justify-content:space-between; margin-bottom:8px;">
                <div class="muted small">Kund</div>
                <button class="btn secondary" id="btnInvPickCustomer">V√§lj/L√§gg till</button>
              </div>
              <div id="invCustomerBox" class="muted small">Ingen kund vald.</div>
            </div>

            <div class="card" style="padding:10px; border-radius:14px; background:rgba(11,18,32,.90);">
              <div class="row" style="justify-content:space-between; margin-bottom:8px;">
                <div class="muted small">Rader</div>
                <div class="row">
                  <button class="btn secondary" id="btnInvAddItem">+ Artikel</button>
                  <button class="btn secondary" id="btnInvAddComment">+ Kommentar</button>
                </div>
              </div>
              <div style="overflow:auto;">
                <table>
                  <thead>
                    <tr>
                      <th>Beskrivning</th>
                      <th class="right" style="width:90px;">Antal</th>
                      <th class="right" style="width:140px;">√Å-pris exkl.</th>
                      <th class="right" style="width:90px;">Moms %</th>
                      <th class="right" style="width:140px;">Radbelopp</th>
                      <th style="width:70px;"></th>
                    </tr>
                  </thead>
                  <tbody id="invLinesTbody"></tbody>
                </table>
              </div>
              <div class="row" style="justify-content:space-between; margin-top:10px;">
                <div class="muted small">Artikelrader r√§knas in i total. Kommentar-rader p√•verkar inte belopp.</div>
                <button class="btn danger" id="btnInvClear">Rensa</button>
              </div>
            </div>

            <div class="card" style="padding:10px; border-radius:14px; background:rgba(11,18,32,.90);">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div class="muted small">Totalt inkl. moms</div>
                  <div id="invTotal" style="font-size:24px; font-weight:900;">‚Äì</div>
                  <div class="muted small">√ñresavrundning <span id="invRounding">0,00</span></div>
                </div>
                <div class="row">
                  <button class="btn secondary" id="btnInvPrint" disabled>F√∂rhandsgranska/skriv ut</button>
                  <button class="btn secondary" id="btnInvToVoucher" disabled>Skapa verifikation</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>Fakturor</h2>
            <div class="row">
              <select id="invYearSelect" aria-label="R√§kenskaps√•r f√∂r fakturor"></select>
              <button class="btn secondary" id="btnInvRefresh">Uppdatera</button>
            </div>
          </div>
          <div id="invoiceList" class="list"></div>
        </div>
      </div>

      <!-- Enkel kund-dialog (utan externa bibliotek) -->
      <dialog id="customerDialog" style="border:1px solid rgba(34,48,68,.8); border-radius:16px; padding:0; max-width:720px; width:calc(100% - 24px); background:rgba(11,15,20,.98); color:var(--text);">
        <div style="padding:14px;">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2 style="margin:0; font-size:14px; color:var(--muted);">Kund</h2>
            <button class="btn secondary" id="btnCustomerClose">St√§ng</button>
          </div>

          <div class="grid" style="gap:10px;">
            <div class="row" style="gap:10px;">
              <div class="field" style="flex:1; min-width:220px;">
                <label>Namn</label>
                <input id="custName" placeholder="t.ex. Mariano Vozzi" />
              </div>
              <div class="field" style="flex:1; min-width:220px;">
                <label>Adress</label>
                <input id="custAddr" placeholder="Gata, postnr, ort" />
              </div>
            </div>
            <div class="row" style="gap:10px;">
              <div class="field" style="flex:1; min-width:220px;">
                <label>E-post (valfritt)</label>
                <input id="custEmail" placeholder="kund@exempel.se" />
              </div>
              <div class="field" style="min-width:180px;">
                <label>Org.nr (valfritt)</label>
                <input id="custOrgnr" placeholder="559999-9999" />
              </div>
            </div>
            <div class="row" style="justify-content:flex-end;">
              <button class="btn" id="btnCustomerSave">Spara & v√§lj</button>
            </div>
            <div style="height:1px; background:rgba(34,48,68,.8); margin:6px 0;"></div>
            <div class="muted small">Befintliga kunder</div>
            <div id="customerList" class="list"></div>
          </div>
        </div>
      </dialog>
    </section>


    
    
    <!-- SRU / DEKLARATION -->
    <section id="tab-sru" hidden>
      <div class="grid two">
        <div class="card">
          <h2>SRU-export (NE) <span class="badge lock" id="sruLockBadge">üîí <b>L√•st</b> ¬∑ beta</span></h2>

          <div class="lockbox" id="sruLockedBox" style="margin-top:10px;">
            <div class="row">
              <div class="muted small">
                SRU √§r f√∂rberett f√∂r <b>blankettstyrd</b> export (b√∂rjar med <b>NE</b>).
                Funktionen syns alltid ‚Äì men √§r l√•st tills du aktiverar den.
              </div>
              <button class="btn" type="button" id="btnEnableSRU">Aktivera SRU (beta)</button>
            </div>
            <div class="muted small" style="margin-top:10px;">
              N√§r SRU √§r aktiv kan du mappa BAS-konton till SRU-f√§ltkoder och exportera <span class="kbd">INFO.SRU</span> + <span class="kbd">BLANKETTER.SRU</span>.
            </div>
          </div>

          <div id="sruUnlockedBox" hidden style="margin-top:10px;">
            <div class="row" style="gap:10px; align-items:end;">
              <div class="field" style="min-width:220px;">
                <label>R√§kenskaps√•r</label>
                <select id="sruYearSelect"></select>
              </div>
              <div class="field" style="min-width:220px;">
                <label>Blankettperiod (suffix)</label>
                <input id="sruPeriodSuffix" placeholder="t.ex. P4" />
              </div>
              <button class="btn" type="button" id="btnExportSRUNE">Exportera INFO.SRU + BLANKETTER.SRU</button>
            </div>
            <div class="muted small" style="margin-top:10px;">
              Exporten bygger p√• din <b>NE-mappning</b> nedan. Belopp h√§mtas fr√•n verifikationsrader i valt √•r.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between; margin-bottom:10px;">
            <h2>NE-mappning</h2>
            <div class="row">
              <button class="btn secondary" type="button" id="btnSruAddMap">+ Rad</button>
              <button class="btn" type="button" id="btnSruSaveMap">Spara mappning</button>
            </div>
          </div>
          <div class="muted small" style="margin-bottom:10px;">
            Ange SRU-f√§ltkod (t.ex. <span class="kbd">R1</span>), och vilka konton som ska summeras.
            Kontofilter kan vara: <span class="kbd">1930</span>, <span class="kbd">30*</span>, eller intervall <span class="kbd">3000-3099</span>. Separera flera med komma.
          </div>

          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th style="width:120px;">F√§ltkod</th>
                  <th style="width:220px;">Kontofilter</th>
                  <th style="width:140px;">Tecken</th>
                  <th>Kommentar</th>
                  <th style="width:70px;"></th>
                </tr>
              </thead>
              <tbody id="sruMapTbody"></tbody>
            </table>
          </div>

          <div class="muted small" style="margin-top:10px;">
            Tips: Om du vill att ett konto ska minska v√§rdet i f√§ltet, v√§lj <b>Invertera</b> p√• den raden.
          </div>
        </div>
      </div>
    </section>

<section id="tab-export" hidden>
      <div class="grid two">
        <div class="card">
          <h2>SIE-export (Typ 4)</h2>
          <div class="row" style="gap:10px;">
            <select id="sieYearSelect"></select>
            <button class="btn" id="btnExportSie4">Ladda ner SIE4</button>
          </div>
          <p class="muted small" style="margin-top:10px;">
            Exporten f√∂ljer SIE 4B-principerna (#VER/#TRANS, samt #IB/#UB f√∂r balanskonto). Om mottagande program √§r super-strikt med teckenkodning (PC8/CP437) kan du beh√∂va spara om filen via en editor som kan konvertera encoding.
          </p>

        </div>

        <div class="card">
          <h2>SIE-import</h2>
          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <select id="sieImportEncoding" title="Teckenkodning">
              <option value="utf-8">UTF-8</option>
              <option value="windows-1252">Windows-1252</option>
              <option value="ibm437">IBM437 (PC8/CP437)</option>
            </select>
            <label class="btn secondary" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
              V√§lj SIE-fil
              <input id="sieImportFile" type="file" hidden />
            </label>
            <button class="btn" id="btnImportSie">Importera</button>
            <label class="muted small" style="display:flex; align-items:center; gap:8px;">
              <input id="sieImportWipe" type="checkbox" /> Rensa innan import
            </label>
          </div>
          <p class="muted small" style="margin-top:10px;">
            Importen l√§ser #KONTO, #RAR, #VER/#TRANS (objekt ignoreras). Tips: om importen blir konstig, testa att byta teckenkodning (m√•nga SIE √§r PC8/CP437).
          </p>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" hidden>
      <div class="grid two">
        <div class="card">
          <h2>F√∂retagsuppgifter</h2>
          <div class="grid" style="gap:10px;">
            <div class="field">
              <label>F√∂retagsnamn</label>
              <input id="sCompany" placeholder="t.ex. Innovatio Brutalis AB" />
            </div>
            <div class="row" style="gap:10px;">
              <div class="field" style="flex:1; min-width:220px;">
                <label>Org.nr (f√∂r SIE)</label>
                <input id="sOrgnr" placeholder="t.ex. 559999-9999" />
              </div>
              <div class="field" style="min-width:170px;">
                <label>Valuta</label>
                <select id="sCurrency">
                  <option>SEK</option>
                  <option>NOK</option>
                  <option>DKK</option>
                  <option>EUR</option>
                  <option>USD</option>
                </select>
              </div>
              <div class="field" style="min-width:140px;">
                <label>Sign (default)</label>
                <input id="sSign" placeholder="t.ex. MA" />
              </div>
            </div>
            <div style="height:1px; background:rgba(34,48,68,.8); margin:12px 0;"></div>
            <h2>Fakturauppgifter</h2>
            <div class="grid" style="gap:10px;">
              <div class="row" style="gap:10px;">
                <div class="field" style="flex:1; min-width:260px;">
                  <label>Adress</label>
                  <input id="sAddr" placeholder="Gata, nr" />
                </div>
                <div class="field" style="min-width:140px;">
                  <label>Postnr</label>
                  <input id="sZip" placeholder="123 45" />
                </div>
                <div class="field" style="flex:1; min-width:200px;">
                  <label>Ort</label>
                  <input id="sCity" placeholder="Stockholm" />
                </div>
                <div class="field" style="min-width:180px;">
                  <label>Land (valfritt)</label>
                  <input id="sCountry" placeholder="Sverige" />
                </div>
              </div>

              <div class="row" style="gap:10px;">
                <div class="field" style="min-width:220px; flex:1;">
                  <label>E-post</label>
                  <input id="sEmail" placeholder="faktura@dittbolag.se" />
                </div>
                <div class="field" style="min-width:200px;">
                  <label>Telefon</label>
                  <input id="sPhone" placeholder="+46 ..." />
                </div>
                <div class="field" style="min-width:220px;">
                  <label>Webb (valfritt)</label>
                  <input id="sWeb" placeholder="https://..." />
                </div>
              </div>

              <div class="row" style="gap:10px;">
                <div class="field" style="min-width:220px;">
                  <label>Momsreg.nr / VAT (valfritt)</label>
                  <input id="sVat" placeholder="SE559999999901" />
                </div>
                <div class="field" style="min-width:160px;">
                  <label>Betalvillkor (dagar)</label>
                  <input id="sPayDays" inputmode="numeric" placeholder="30" />
                </div>
              </div>

              <div class="row" style="gap:10px; flex-wrap:wrap;">
                <div class="field" style="min-width:220px;">
                  <label>Bankgiro (valfritt)</label>
                  <input id="sBg" placeholder="123-4567" />
                </div>
                <div class="field" style="min-width:220px;">
                  <label>Plusgiro (valfritt)</label>
                  <input id="sPg" placeholder="123456-7" />
                </div>
                <div class="field" style="min-width:220px;">
                  <label>Swish (telefon, valfritt)</label>
                  <input id="sSwish" inputmode="tel" placeholder="t.ex. 0701234567" />
                </div>
                <div class="field" style="min-width:260px; flex:1;">
                  <label>Bankkonto (kontonr, valfritt)</label>
                  <input id="sBankAccount" placeholder="t.ex. 1234-5, 1234567890" />
                </div>
                <div class="field" style="min-width:260px; flex:1;">
                  <label>IBAN (valfritt)</label>
                  <input id="sIban" placeholder="SE..." />
                </div>
                <div class="field" style="min-width:180px;">
                  <label>SWIFT/BIC (valfritt)</label>
                  <input id="sSwift" placeholder="XXXXSESS" />
                </div>
              </div>

              <div class="row" style="gap:10px;">
                <div class="field" style="flex:1; min-width:260px;">
                  <label>Notis p√• faktura (valfritt)</label>
                  <input id="sInvNote" placeholder="t.ex. Tack f√∂r din best√§llning!" />
                </div>
              </div>

              <div class="field">
                <label>Fakturafot / extra info (valfritt)</label>
                <textarea id="sInvFooter" placeholder="t.ex. F√∂rseningsr√§nta 8% + referens..."></textarea>
              </div>

              <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap;">
                <div class="field" style="min-width:260px;">
                  <label>Logotyp (valfritt)</label>
                  <input id="sLogo" type="file" accept="image/*" />
                </div>
                <button class="btn secondary" type="button" id="btnRemoveLogo">Ta bort logotyp</button>
                <div id="logoPreview" class="muted small"></div>
              </div>
            </div>

            
              <div style="height:1px; background:rgba(34,48,68,.8); margin:12px 0;"></div>
              <h2>SRU / Deklaration</h2>
              <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap;">
                <label class="muted small" style="display:flex; align-items:center; gap:8px;">
                  <input id="sSruEnabled" type="checkbox" />
                  Aktivera SRU (NE) ‚Äì avancerat (kr√§ver mappning)
                </label>
                <span class="muted small">Visas alltid i menyn, men √§r l√•st om du inte aktiverar h√§r.</span>
              </div>

            <div class="row" style="justify-content:flex-end;">
              <button class="btn" id="btnSaveSettings">Spara</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>R√§kenskaps√•r</h2>
          <div style="height:1px; background:rgba(34,48,68,.8); margin:12px 0;"></div>
          <h2>Periodl√•s</h2>
          <div class="muted small" style="margin-bottom:10px;">
            L√•s √§ldre perioder s√• att verifikationer inte kan √§ndras/raderas. R√§ttelser g√∂rs via ny verifikation som h√§nvisar till originalet.
          </div>
          <div class="row" style="gap:10px; margin-bottom:10px; align-items:end; flex-wrap:wrap;">
            <div class="field" style="min-width:240px;">
              <label>√Ör</label>
              <select id="lockYear"></select>
            </div>
            <div class="field" style="min-width:200px;">
              <label>L√•s t.o.m (inkl.)</label>
              <input id="lockUntil" type="date" />
            </div>
            <button class="btn" id="btnSetLock">Spara l√•s</button>
            <button class="btn secondary" id="btnClearLock">Ta bort l√•s</button>
          </div>

          <div class="row" style="gap:10px; margin-bottom:10px;">
            <div class="field" style="min-width:160px;">
              <label>Start</label>
              <input id="fyStart" type="date" />
            </div>
            <div class="field" style="min-width:160px;">
              <label>Slut</label>
              <input id="fyEnd" type="date" />
            </div>
            <button class="btn" id="btnAddYear">L√§gg till √•r</button>
          </div>
          <div class="row" style="gap:10px; margin-bottom:10px; align-items:end;">
            <div class="field" style="min-width:240px;">
              <label>IB fr√•n (√•r)</label>
              <select id="carryFrom"></select>
            </div>
            <div class="field" style="min-width:240px;">
              <label>IB till (√•r)</label>
              <select id="carryTo"></select>
            </div>
            <button class="btn secondary" id="btnCarry">F√∂r √∂ver IB (balanskonto)</button>
          </div>
          <div class="muted small">F√∂r √∂ver IB skapar en verifikation p√• f√∂rsta dagen i ‚ÄùTill‚Äù-√•ret med text ‚ÄúIng√•ende balans‚Äù.</div>
          <div style="overflow:auto; margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th>√Ör-id</th>
                  <th>Start</th>
                  <th>Slut</th>
                  <th style="width:70px;"></th>
                </tr>
              </thead>
              <tbody id="yearsTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>Fil-synk (Drive-mapp, valfritt)</h2>
          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <button class="btn" id="btnConnectFile">V√§lj befintlig datafil</button>
            <button class="btn secondary" id="btnCreateFile">Skapa ny datafil</button>
            <button class="btn secondary" id="btnLoadFromFile" disabled>L√§s in</button>
            <button class="btn secondary" id="btnSaveToFile" disabled>Spara nu</button>
            <button class="btn danger" id="btnDisconnectFile" disabled>Koppla fr√•n</button>
          </div>
          <div class="row" style="gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap;">
            <label class="muted small" style="display:flex; align-items:center; gap:8px;">
              <input id="fsAutosave" type="checkbox" /> Autospara till fil
            </label>
            <label class="muted small" style="display:flex; align-items:center; gap:8px;">
              <input id="fsRequireFile" type="checkbox" /> Kr√§v datafil (ingen bokf√∂ring utan fil)
            </label>
            <span id="fsStatus" class="status bad">Inte ansluten</span>
          </div>
          <p class="muted small" style="margin-top:10px;">
            Detta anv√§nder File System Access API (Chrome/Edge) och fungerar i <b>secure context</b> (HTTPS eller localhost). V√§lj en fil i en Google Drive-synkad mapp s√• syncas den av Drive for desktop.
          </p>
        </div>

        <div class="card">
          <h2>Backup (JSON)</h2>
          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <button class="btn" id="btnExportJson">Ladda ner backup.json</button>
            <label class="btn secondary" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
              Importera JSON
              <input id="jsonImport" type="file" accept="application/json" hidden />
            </label>
            <button class="btn danger" id="btnWipe">Rensa ALL data</button>
          </div>
          <p class="muted small" style="margin-top:10px;">Tips: ta en backup innan du g√∂r bokslutsverifikationer.</p>
        </div>

        <div class="card">
          <h2>Arkivering (√•rspaket)</h2>
          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <select id="archiveYearSelect" aria-label="R√§kenskaps√•r f√∂r arkiv"></select>
            <button class="btn" id="btnMakeArchive">Skapa arkivpaket</button>
          </div>
          <p class="muted small" style="margin-top:10px;">
            Skapar en fryst export f√∂r valt √•r (kontoplan, verifikationer, fakturor + relevanta register) samt en SHA-256 checksumma.
            Spara b√•da filerna p√• ett s√§kert st√§lle (t.ex. skrivskyddad plats / offline-kopia). Programmet kan inte garantera arkivering om du bara har localStorage.
          </p>

          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <label class="btn secondary" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
              V√§lj arkiv-JSON
              <input id="archiveImportJson" type="file" accept="application/json" hidden />
            </label>
            <label class="btn secondary" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
              V√§lj .sha256 (valfritt)
              <input id="archiveImportSha" type="file" accept="text/plain" hidden />
            </label>
            <button class="btn secondary" id="btnVerifyArchive">Verifiera arkiv</button>
          </div>
          <div id="archiveVerifyResult" class="muted small" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>
      </div>
    </div>
  </div>
</main>

<div id="appToast" class="toast" hidden role="status" aria-live="polite"></div>

<div id="appConfirm" class="modal-backdrop" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="appConfirmTitle" aria-describedby="appConfirmMessage">
    <div id="appConfirmTitle" style="font-weight:800; margin-bottom:6px;">Bekr√§fta</div>
    <div id="appConfirmMessage" class="muted small"></div>
    <div class="actions">
      <button type="button" class="btn secondary" id="appConfirmCancel">Avbryt</button>
      <button type="button" class="btn danger" id="appConfirmOk">OK</button>
    </div>
  </div>
</div>

<script>
(function(){
 

  const APP_VERSION = "1.1"; // bump when adding new data fields
  const STORAGE_KEY = "FU_BOOKKEEPING_STATE";

  const bootPill = document.getElementById("bootPill");
  const setBoot = (text) => { if (bootPill) bootPill.textContent = text; };
  setBoot("JS: OK");
  window.addEventListener("error", (ev) => {
    try {
      const msg = ev && ev.message ? String(ev.message) : "(ok√§nt fel)";
      setBoot(`JS: fel ¬∑ ${msg}`.slice(0, 60));
    } catch { setBoot("JS: fel (konsol)"); }
    try { console.error("Global error", ev && ev.error ? ev.error : ev); } catch {}
  });
  window.addEventListener("unhandledrejection", (ev) => {
    try {
      const reason = ev && ev.reason ? ev.reason : "(ok√§nd promise-rejection)";
      const msg = (reason && (reason.message || reason.name)) ? String(reason.message || reason.name) : String(reason);
      setBoot(`JS: fel ¬∑ ${msg}`.slice(0, 60));
    } catch { setBoot("JS: fel (konsol)"); }
    try { console.error("Unhandled rejection", ev && ev.reason ? ev.reason : ev); } catch {}
  });

  // In-app toast (used to avoid browser alert header text)
  const appToast = document.getElementById("appToast");
  let toastTimer = null;
  function showToast(message, ms = 2200){
    if (!appToast) return;
    if (toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
    appToast.textContent = String(message ?? "");
    appToast.hidden = false;
    toastTimer = setTimeout(() => {
      appToast.hidden = true;
    }, ms);
  }

  // In-app confirm (replaces browser confirm dialogs)
  const appConfirm = document.getElementById("appConfirm");
  const appConfirmMessage = document.getElementById("appConfirmMessage");
  const appConfirmOk = document.getElementById("appConfirmOk");
  const appConfirmCancel = document.getElementById("appConfirmCancel");
  let confirmResolve = null;
  let confirmKeyHandler = null;

  function hideConfirm(result){
    if (!appConfirm) return;
    try { appConfirm.hidden = true; } catch {}
    try { if (confirmKeyHandler) document.removeEventListener("keydown", confirmKeyHandler, true); } catch {}
    if (!confirmResolve){
      confirmKeyHandler = null;
      return;
    }
    const r = confirmResolve;
    confirmResolve = null;
    confirmKeyHandler = null;
    try { r(!!result); } catch {}
  }

  function confirmAsync(message, options = {}){
    return new Promise((resolve)=>{
      const msg = String(message ?? "");
      if (!appConfirm || !appConfirmMessage || !appConfirmOk || !appConfirmCancel){
        resolve(!!window.confirm(msg));
        return;
      }

      // Close any previous pending confirm
      if (confirmResolve){
        try { confirmResolve(false); } catch {}
        confirmResolve = null;
      }

      appConfirmMessage.textContent = msg;
      appConfirmOk.textContent = String(options.okText ?? "OK");
      appConfirmCancel.textContent = String(options.cancelText ?? "Avbryt");

      const okKind = String(options.okKind ?? "danger");
      appConfirmOk.className = "btn" + (okKind === "danger" ? " danger" : (okKind === "secondary" ? " secondary" : ""));
      appConfirmCancel.className = "btn secondary";

      appConfirm.hidden = false;
      confirmResolve = resolve;

      confirmKeyHandler = (e)=>{
        if (e.key === "Escape"){
          e.preventDefault();
          hideConfirm(false);
          return;
        }
        if (e.key === "Enter"){
          e.preventDefault();
          hideConfirm(true);
        }
      };
      document.addEventListener("keydown", confirmKeyHandler, true);

      setTimeout(()=>{
        try { appConfirmOk.focus(); } catch {}
      }, 0);
    });
  }

  if (appConfirmOk) appConfirmOk.addEventListener("click", ()=> hideConfirm(true));
  if (appConfirmCancel) appConfirmCancel.addEventListener("click", ()=> hideConfirm(false));
  if (appConfirm) appConfirm.addEventListener("click", (e)=>{ if (e.target === appConfirm) hideConfirm(false); });


  // --- Utilities ---
  const fmtSEK = (n) => {
    if (!Number.isFinite(n)) return "‚Äì";
    return n.toLocaleString("sv-SE", {minimumFractionDigits: 2, maximumFractionDigits: 2});
  };
  const parseMoney = (s) => {
    if (s == null) return 0;
    const t = String(s).trim().replace(/\s+/g, "").replace(",", ".");
    if (t === "") return 0;
    const v = Number(t);
    return Number.isFinite(v) ? v : 0;
  };
  const ymd = (d) => d.replaceAll("-", "");
  const todayISO = () => new Date().toISOString().slice(0,10);
  const clampText = (s, max=120) => String(s ?? "").slice(0,max);

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }
  function escapeAttr(s){
    // For quoted attributes; reuse HTML escaping.
    return escapeHtml(s);
  }

  // Download helper (creates a local file download)
  function downloadText(filename, text, mime="text/plain"){
    const blob = new Blob([text], { type: mime });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
  }

  function ymd8ToIso(s){
    const t = String(s || "").trim();
    if (!/^\d{8}$/.test(t)) return "";
    return `${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}`;
  }
  function isoToYmd8(iso){
    const t = String(iso || "").trim();
    if (/^\d{8}$/.test(t)) return t;
    if (/^\d{4}-\d{2}-\d{2}$/.test(t)) return t.replaceAll("-", "");
    return "";
  }
  function sieQuote(s){
    return `"${String(s ?? "").replaceAll('"', "''")}"`;
  }
  function sieTokens(line){
    const out = [];
    const re = /"([^"]*)"|(\S+)/g;
    let m;
    while ((m = re.exec(String(line || ""))) !== null){
      out.push(m[1] != null ? m[1] : m[2]);
    }
    return out;
  }

  function normalizeImportedState(d){
    const base = defaultData();
    const o = (d && typeof d === "object") ? d : base;

    if (!o.company) o.company = base.company;
    const cdef = base.company;
    o.company = o.company || {};
    for (const k of Object.keys(cdef)) if (o.company[k] == null) o.company[k] = cdef[k];

    if (!o.features) o.features = { sruEnabled: false };
    if (typeof o.features.sruEnabled !== "boolean") o.features.sruEnabled = false;

    if (!o.fileSync) o.fileSync = { autosave: true, requireFile: false };
    if (typeof o.fileSync.autosave !== "boolean") o.fileSync.autosave = true;
    if (typeof o.fileSync.requireFile !== "boolean") o.fileSync.requireFile = false;

    if (!Array.isArray(o.fiscalYears)) o.fiscalYears = base.fiscalYears;
    if (!o.activeYearId) o.activeYearId = o.fiscalYears[0]?.id ?? String(new Date().getFullYear());
    if (!o.accounts) o.accounts = demoAccounts();
    if (!Array.isArray(o.vouchers)) o.vouchers = [];
    if (!o.customers) o.customers = {};
    if (!o.suppliers) o.suppliers = {};
    if (!Array.isArray(o.invoices)) o.invoices = [];
    if (!o.locks || typeof o.locks !== "object") o.locks = {};
    if (!o.compliance) o.compliance = { immutableVouchers: true };
    if (!Array.isArray(o.auditLog)) o.auditLog = [];
    if (!o.sru) o.sru = { enabled:false, periodSuffix:"P4", neMappings: [] };
    if (typeof o.sru.enabled !== "boolean") o.sru.enabled = false;
    if (!o.sru.periodSuffix) o.sru.periodSuffix = "P4";
    if (!Array.isArray(o.sru.neMappings)) o.sru.neMappings = [];
    return o;
  }

  function exportBackupJson(){
    const json = JSON.stringify(state, null, 2) + "\n";
    downloadText("backup.json", json, "application/json");
  }

  async function importBackupJsonFile(file){
    if (!file) return;
    const txt = await file.text();
    const d = JSON.parse(txt);
    state = normalizeImportedState(d);
    try { fillYearSelectors(); } catch (e){ console.error(e); }
    save();
    try { newVoucher(); } catch (e){ console.error(e); }
    try { newInvoice(); } catch (e){ console.error(e); }
    try { renderAll(); } catch (e){ console.error(e); }
    showToast("Import klar.", 3000);
  }

  async function wipeAllData(){
    if (!(await confirmAsync("Rensa ALL data? Detta kan inte √•ngras. Ta en backup f√∂rst."))) return;
    try { localStorage.removeItem(STORAGE_KEY); } catch (e){ console.error(e); }
    try { await fsDisconnect(); } catch (e){ /* ignore */ }
    state = defaultData();
    try { fillYearSelectors(); } catch (e){ console.error(e); }
    save();
    try { newVoucher(); } catch (e){ console.error(e); }
    try { newInvoice(); } catch (e){ console.error(e); }
    try { renderAll(); } catch (e){ console.error(e); }
    showToast("All data rensad.", 3500);
  }

  function exportSie4(yearId){
    const yid = String(yearId || state.activeYearId || "").trim();
    if (!yid) return showToast("V√§lj √•r.", 3500);

    const fy = (state.fiscalYears||[]).find(y=>String(y.id)===yid) || null;
    const vs = (state.vouchers||[])
      .filter(v => String(v.yearId) === yid)
      .slice()
      .sort((a,b)=> (a.date+a.series+a.no).localeCompare(b.date+b.series+b.no, "sv"));

    const lines = [];
    lines.push("#FLAGGA 0");
    lines.push(`#PROGRAM ${sieQuote("FU-BOOKKEEPING")} ${APP_VERSION}`);
    lines.push(`#GEN ${isoToYmd8(todayISO())}`);
    lines.push("#SIETYP 4");
    if (state.company?.name) lines.push(`#FNAMN ${sieQuote(state.company.name)}`);
    if (state.company?.orgnr) lines.push(`#ORGNR ${state.company.orgnr}`);
    if (fy && fy.start && fy.end) lines.push(`#RAR 0 ${isoToYmd8(fy.start)} ${isoToYmd8(fy.end)}`);

    Object.keys(state.accounts||{}).sort((a,b)=>a.localeCompare(b,"sv")).forEach(acc=>{
      const nm = state.accounts[acc]?.name || "";
      lines.push(`#KONTO ${acc} ${sieQuote(nm)}`);
    });

    vs.forEach(v=>{
      const series = (v.series || "A").trim() || "A";
      const no = (v.no || "").trim() || "0";
      const dt = isoToYmd8(v.date || "") || isoToYmd8(todayISO());
      const txt = v.text || "";
      const sign = v.sign || "";
      lines.push(`#VER ${series} ${no} ${dt} ${sieQuote(txt)} ${sieQuote(sign)}`);
      (v.lines||[]).forEach(l=>{
        const acc = String(l.account || "").trim();
        if (!acc) return;
        const amt = Math.round((Number(l.amount)||0)*100)/100;
        const amtTxt = (Number.isFinite(amt) ? amt.toFixed(2) : "0.00");
        const lt = l.text || v.text || "";
        lines.push(`#TRANS ${acc} {} ${amtTxt} ${dt} ${sieQuote(lt)}`);
      });
      lines.push("{");
      lines.push("}");
    });
    lines.push("#END");

    const filename = `SIE4_${yid}.se`;
    downloadText(filename, lines.join("\n") + "\n", "text/plain");
  }

  async function importSieFile(file, encoding, wipe){
    if (!file) return showToast("V√§lj en SIE-fil f√∂rst.", 3500);
    if (wipe && !(await confirmAsync("Rensa innan import? (Rekommenderas endast om du vill ers√§tta allt.)"))) return;

    const buf = await file.arrayBuffer();
    const preferred = String(encoding || "utf-8");
    const dec = decodeWithBestEncoding(buf, preferred);
    const txt = dec.text;
    if (dec.enc && String(dec.enc) !== String(preferred)){
      showToast(`Teckenkodning: anv√§nde ${dec.enc} (i st√§llet f√∂r ${preferred}) f√∂r att undvika "ÔøΩ".`, 6500);
    }

    if (wipe){
      // Keep company defaults but wipe data.
      const keepCompany = state?.company || defaultData().company;
      state = defaultData();
      state.company = { ...state.company, ...keepCompany };
    }

    state = normalizeImportedState(state);

    const importedAccounts = {};
    const importedYears = [];
    const importedVouchers = [];

    let currentYearId = "";
    let cur = null;

    const flush = ()=>{
      if (!cur) return;
      if (!Array.isArray(cur.lines)) cur.lines = [];
      // skip empty
      if (!cur.series && !cur.no && !cur.lines.length){ cur = null; return; }
      if (!cur.id) cur.id = crypto.randomUUID();
      if (!cur.regDate) cur.regDate = todayISO();
      if (!cur.sign) cur.sign = state.company?.defaultSign || "";
      if (!cur.yearId) cur.yearId = currentYearId || (cur.date ? String(cur.date).slice(0,4) : state.activeYearId);
      importedVouchers.push(cur);
      cur = null;
    };

    const lines = String(txt).split(/\r?\n/);
    for (const rawLine of lines){
      const line = rawLine.trim();
      if (!line) continue;
      if (!line.startsWith("#")) continue;

      const t = sieTokens(line);
      const tag = t[0];

      if (tag === "#FNAMN" && t[1] != null){
        state.company = state.company || defaultData().company;
        state.company.name = String(t.slice(1).join(" ") || "").trim();
        continue;
      }
      if (tag === "#ORGNR" && t[1] != null){
        state.company = state.company || defaultData().company;
        state.company.orgnr = String(t[1] || "").trim();
        continue;
      }

      if (tag === "#RAR" && t.length >= 4){
        const start = ymd8ToIso(t[2]);
        const end = ymd8ToIso(t[3]);
        const yid = (start ? start.slice(0,4) : "");
        if (yid){
          currentYearId = yid;
          importedYears.push({ id: yid, start: start || `${yid}-01-01`, end: end || `${yid}-12-31` });
        }
        continue;
      }

      if (tag === "#KONTO" && t.length >= 3){
        const acc = String(t[1] || "").trim();
        const name = String(t[2] || "").trim();
        if (acc) importedAccounts[acc] = { name, type: (state.accounts && state.accounts[acc] && state.accounts[acc].type) ? state.accounts[acc].type : "other" };
        continue;
      }

      if (tag === "#VER"){
        flush();
        const series = String(t[1] || "A").trim() || "A";
        const no = String(t[2] || "0").trim() || "0";
        const date = ymd8ToIso(t[3]) || todayISO();
        const text = (t[4] != null ? String(t[4]) : "").trim();
        const sign = (t[5] != null ? String(t[5]) : "").trim();
        const yid = currentYearId || date.slice(0,4);
        currentYearId = yid;
        cur = {
          id: crypto.randomUUID(),
          yearId: yid,
          series,
          no,
          date,
          text,
          regDate: todayISO(),
          sign,
          lines: [],
          correctionOf: null
        };
        continue;
      }

      if (tag === "#TRANS" && cur){
        const acc = String(t[1] || "").trim();
        // Find first numeric token after account/optional object token
        let amt = 0;
        for (let i = 2; i < t.length; i++){
          const v = String(t[i] || "");
          if (v === "{}" || v === "{" || v === "}") continue;
          const n = Number(v.replace(",", "."));
          if (Number.isFinite(n)) { amt = n; break; }
        }
        const text = (t[t.length-1] != null ? String(t[t.length-1]) : "").trim();
        if (acc){
          cur.lines.push({ account: acc, text, amount: Math.round(amt*100)/100 });
        }
        continue;
      }
    }
    flush();

    // Merge fiscal years
    state.fiscalYears = state.fiscalYears || [];
    importedYears.forEach(y=>{
      if (!y || !y.id) return;
      const exists = state.fiscalYears.find(x=>String(x.id)===String(y.id));
      if (!exists) state.fiscalYears.push(y);
    });
    state.fiscalYears.sort((a,b)=>String(a.id).localeCompare(String(b.id),"sv"));

    // Merge accounts
    state.accounts = state.accounts || {};
    Object.entries(importedAccounts).forEach(([acc, meta])=>{
      if (!acc) return;
      state.accounts[acc] = state.accounts[acc] || { name: meta.name || "", type: meta.type || "other" };
      if (meta.name) state.accounts[acc].name = meta.name;
    });

    // Merge vouchers
    state.vouchers = state.vouchers || [];
    importedVouchers.forEach(v=> state.vouchers.push(v));

    // Pick active year
    const active = currentYearId || state.activeYearId || state.fiscalYears[0]?.id;
    if (active) state.activeYearId = active;

    try { fillYearSelectors(); } catch (e){ console.error(e); }
    save();
    try { newVoucher(); } catch (e){ console.error(e); }
    try { renderAll(); } catch (e){ console.error(e); }
    showToast(`SIE-import klar. Importerade ${Object.keys(importedAccounts).length} konton och ${importedVouchers.length} verifikationer.`, 5500);
  }

  async function sha256Hex(text){
    const data = new TextEncoder().encode(String(text));
    const hash = await crypto.subtle.digest("SHA-256", data);
    const bytes = Array.from(new Uint8Array(hash));
    return bytes.map(b => b.toString(16).padStart(2,"0")).join("");
  }
  function archiveBuildObject(yearId){
    const fy = (state.fiscalYears||[]).find(y=>y.id===yearId) || null;
    const vouchers = (state.vouchers||[]).filter(v=>v.yearId===yearId);
    const invoices = (state.invoices||[]).filter(i=>i.yearId===yearId);

    // collect referenced customers/suppliers (keep minimal but sufficient)
    const customers = {};
    for (const inv of invoices){
      const cid = inv.customerId;
      if (cid && state.customers && state.customers[cid]) customers[cid] = state.customers[cid];
    }
    const suppliers = {}; // reserved for future supplier docs
    return {
      schema: "FU_BOOKKEEPING_ARCHIVE_V1",
      app: "FU-BOOKKEEPING",
      appVersion: APP_VERSION,
      createdAt: new Date().toISOString(),
      yearId,
      fiscalYear: fy,
      company: {
        name: state.company?.name || "",
        orgnr: state.company?.orgnr || "",
        currency: state.company?.currency || "SEK",
        addr: state.company?.addr || "",
        zip: state.company?.zip || "",
        city: state.company?.city || "",
        country: state.company?.country || "",
        email: state.company?.email || "",
        phone: state.company?.phone || "",
        web: state.company?.web || "",
        vat: state.company?.vat || "",
        payDays: state.company?.payDays ?? 30,
        bankgiro: state.company?.bankgiro || "",
        plusgiro: state.company?.plusgiro || "",
        iban: state.company?.iban || "",
        swift: state.company?.swift || "",
        invoiceNote: state.company?.invoiceNote || "",
        invoiceFooter: state.company?.invoiceFooter || "",
        logoDataUrl: state.company?.logoDataUrl || ""
      },
      accounts: state.accounts || {},
      vouchers,
      invoices,
      customers,
      suppliers,
      notes: "Arkivexport: spara JSON + SHA256 p√• en plats du kontrollerar. F√∂r l√•ngtidsarkiv: g√∂r √§ven offline-kopia (t.ex. extern disk/print/PDF)."
    };
  }

  async function makeArchive(yearId){
    if (!yearId) return showToast("V√§lj r√§kenskaps√•r.", 3500);
    const obj = archiveBuildObject(yearId);
    const json = JSON.stringify(obj, null, 2) + "\n";
    const sha = await sha256Hex(json);
    const ts = new Date().toISOString().replace(/[:.]/g,"-").slice(0,19);
    const base = `FU_ARCHIVE_${yearId}_${ts}`;
    downloadText(base + ".json", json, "application/json");
    downloadText(base + ".sha256.txt", sha + "  " + base + ".json\n", "text/plain");
    if (archiveVerifyResult) archiveVerifyResult.textContent = `Skapade arkiv f√∂r ${yearId}. SHA-256: ${sha.slice(0,12)}‚Ä¶`;
  }

  async function verifyArchive(){
    const fJson = archiveImportJson && archiveImportJson.files ? archiveImportJson.files[0] : null;
    if (!fJson) return showToast("V√§lj en arkiv-JSON f√∂rst.", 3500);
    const txt = await fJson.text();
    let shaProvided = "";
    const fSha = archiveImportSha && archiveImportSha.files ? archiveImportSha.files[0] : null;
    if (fSha){
      const s = (await fSha.text()).trim();
      // accept formats like: "<hash>  filename"
      shaProvided = s.split(/\s+/)[0].trim().toLowerCase();
    }
    const shaCalc = await sha256Hex(txt);
    const ok = shaProvided ? (shaCalc === shaProvided) : true;

    let meta = "";
    try{
      const obj = JSON.parse(txt);
      if (obj && obj.schema) meta = ` ¬∑ ${obj.schema} ¬∑ √•r ${obj.yearId || "?"}`;
    } catch {}

    if (archiveVerifyResult){
      archiveVerifyResult.innerHTML = ok
        ? `<span class="status ok">OK</span> SHA-256: <span class="kbd">${shaCalc}</span>${meta}`
        : `<span class="status bad">FEL</span> Ber√§knad SHA-256: <span class="kbd">${shaCalc}</span> ¬∑ Filens SHA: <span class="kbd">${shaProvided}</span>${meta}`;
    } else {
      showToast(ok ? "Arkiv OK" : "Arkiv FEL (checksum matchar inte)", 5500);
    }
  }




  // --- Year selector sync (single source of truth) ---
  function fillYearSelectors(){
    const ys = (state.fiscalYears||[]).slice().sort((a,b)=>String(a.id).localeCompare(String(b.id),"sv"));
    const active = state.activeYearId || ys[0]?.id || "";

    function fillSelect(sel, prefer){
      if (!sel) return;
      const prev = prefer ?? sel.value;
      sel.innerHTML = "";
      ys.forEach(y=>{
        const opt = document.createElement("option");
        opt.value = y.id;
        opt.textContent = `${y.id} (${y.start} ‚Äì ${y.end})`;
        sel.appendChild(opt);
      });
      sel.value = ys.find(y=>y.id===prev)?.id || ys.find(y=>y.id===active)?.id || ys[0]?.id || "";
    }

    fillSelect(yearSelect, active);
  fillSelect(rptYearSelect, active);
    fillSelect(sieYearSelect, active);
    fillSelect(archiveYearSelect, active);
    fillSelect(carryFrom, ys[0]?.id || active);
    fillSelect(carryTo, active);
    fillSelect(invYearSelect, active);
    fillSelect(lockYear, active);

    if (yearPillSelect){
      const prev = yearPillSelect.value;
      yearPillSelect.innerHTML = "";
      ys.forEach(y=>{
        const opt = document.createElement("option");
        opt.value = y.id;
        opt.textContent = `R√§kenskaps√•r: ${y.id} (${y.start} ‚Äì ${y.end})`;
        yearPillSelect.appendChild(opt);
      });
      yearPillSelect.value = ys.find(y=>y.id===active)?.id || ys.find(y=>y.id===prev)?.id || ys[0]?.id || "";
    }

    // period lock UI
    if (lockYear && lockUntil){
      const yid = lockYear.value || active;
      lockUntil.value = lockUntilForYear(yid);
    }
  }


  // --- Print helpers ---
  function printHtmlDocument(title, bodyHtml){
    const doc = `<!doctype html><html><head><meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>${title}</title>
      <style>
        body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; padding:24px; color:#111; background:#fff; }
          div.addEventListener("click", async (e)=>{
        .muted{ color:#555; }
        .card{ border:1px solid #ddd; border-radius:12px; padding:12px; margin:0 0 12px 0; background:#fff; }
        table{ width:100%; border-collapse:collapse; margin-top:10px; }
        th,td{ border-bottom:1px solid #ddd; padding:6px 6px; text-align:left; vertical-align:top; }
        th{ font-size:12px; color:#333; }
        td{ font-size:12px; }
            if (act==="del") await deleteInvoice(id);
        .row{ display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start; }
        @media print{
          body{ padding:0; }
          .noprint{ display:none !important; }
          .card{ page-break-inside:avoid; }
        }
      </style>
    </head><body>${bodyHtml}<script>window.onload=()=>window.print();<\/script></body></html>`;
    const w = window.open("", "_blank");
    if (!w) return showToast("Popup blockerad. Till√•t popup f√∂r att skriva ut.", 6000);
    w.document.open();
    w.document.write(doc);
    w.document.close();
  }
  // --- IndexedDB (f√∂r att lagra fil-handle mellan sessioner) ---
  const IDB_DB = "mini_bokforing_idb";
  const IDB_STORE = "kv";

  function idbOpen(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(IDB_DB, 1);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if (!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE);
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }

  async function idbGet(key){
    const db = await idbOpen();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(IDB_STORE, "readonly");
      const st = tx.objectStore(IDB_STORE);
      const req = st.get(key);
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }

  async function idbSet(key, value){
    const db = await idbOpen();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(IDB_STORE, "readwrite");
      const st = tx.objectStore(IDB_STORE);
      const req = st.put(value, key);
      req.onsuccess = ()=> resolve(true);
      req.onerror = ()=> reject(req.error);
    });
  }

  async function idbDel(key){
    const db = await idbOpen();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(IDB_STORE, "readwrite");
      const st = tx.objectStore(IDB_STORE);
      const req = st.delete(key);
      req.onsuccess = ()=> resolve(true);
      req.onerror = ()=> reject(req.error);
    });
  }

  function defaultData(){
    const now = new Date();
    const y = now.getFullYear();
    return {
      company: { name: "FU-BOOKKEEPING", orgnr: "", currency: "SEK", defaultSign: "", addr:"", zip:"", city:"", country:"", email:"", phone:"", web:"", vat:"", payDays:30, bankgiro:"", plusgiro:"", swishPhone:"", bankAccountNo:"", iban:"", swift:"", invoiceNote:"", invoiceFooter:"", logoDataUrl:"" },
      features: { sruEnabled: false },
      fileSync: { autosave: true, requireFile: false },
      fiscalYears: [
        { id: String(y-1), start: `${y-1}-01-01`, end: `${y-1}-12-31` },
        { id: String(y),   start: `${y}-01-01`,   end: `${y}-12-31` },
      ],
      activeYearId: String(y),
      accounts: demoAccounts(),
      vouchers: [],
      customers: {},
      suppliers: {},
      invoices: [],
      locks: {},
      compliance: { immutableVouchers: true },
      auditLog: [],
      sru: { enabled: false, periodSuffix: "P4", neMappings: [] }
    };
  }

  function demoAccounts(){
    // Minimal BAS-ish set (du kan l√§gga fler i Kontoplan)
    return {
      "1510": { name: "Kundfordringar", type: "asset" },
      "1630": { name: "Skattekonto", type: "asset" },
      "1930": { name: "F√∂retagskonto/bank", type: "asset" },
      "1460": { name: "Varulager", type: "asset" },
      "2013": { name: "Eget uttag", type: "liability" },
      "2019": { name: "√Örets resultat", type: "liability" },
      "2611": { name: "Utg√•ende moms 25 %", type: "liability" },
      "3001": { name: "F√∂rs√§ljning varor 25 %", type: "income" },
      "4960": { name: "F√∂r√§ndring av lager", type: "expense" },
      "8999": { name: "√Örets resultat (resultatkonto)", type: "other" }
    };
      
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return defaultData();
    try {
      const d = JSON.parse(raw);
      // very light migration defaults
      if (!d.company) d.company = defaultData().company;
            // company invoice defaults
      const cdef = defaultData().company;
      d.company = d.company || {};
      for (const k of Object.keys(cdef)) if (d.company[k] == null) d.company[k] = cdef[k];
if (!d.features) d.features = { sruEnabled: false };
      if (typeof d.features.sruEnabled !== "boolean") d.features.sruEnabled = false;
      if (!d.fileSync) d.fileSync = { autosave: true, requireFile: false };
      if (typeof d.fileSync.requireFile !== "boolean") d.fileSync.requireFile = false;
      if (!d.fiscalYears) d.fiscalYears = defaultData().fiscalYears;
      if (!d.accounts) d.accounts = demoAccounts();
      if (!d.vouchers) d.vouchers = [];
      if (!d.customers) d.customers = {};
      if (!d.suppliers) d.suppliers = {};
      if (!d.invoices) d.invoices = [];
      
      
      if (!d.locks || typeof d.locks !== "object") d.locks = {};
      if (!d.compliance) d.compliance = { immutableVouchers: true };
      if (!d.auditLog) d.auditLog = [];
      if (!d.sru) d.sru = { enabled:false, periodSuffix:"P4", neMappings: [] };
      if (typeof d.sru.enabled !== "boolean") d.sru.enabled = false;
      if (!d.sru.periodSuffix) d.sru.periodSuffix = "P4";
      if (!Array.isArray(d.sru.neMappings)) d.sru.neMappings = [];
      if (!d.activeYearId) d.activeYearId = d.fiscalYears[0]?.id ?? String(new Date().getFullYear());
      return d;
    } catch {
      return defaultData();
    }
  }
  function save(){
    const isQuotaError = (e) => {
      const name = e && e.name ? String(e.name) : "";
      const msg = e && e.message ? String(e.message) : "";
      return name === "QuotaExceededError" || /quota/i.test(msg) || e?.code === 22 || e?.code === 1014;
    };

    let persisted = false;
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      persisted = true;
    } catch (e){
      console.error(e);

      // If state is too large, the most common culprit is an embedded logo.
      if (isQuotaError(e) && state?.company?.logoDataUrl){
        const prev = state.company.logoDataUrl;
        try {
          state.company.logoDataUrl = "";
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          persisted = true;
          showToast("Kunde inte spara p.g.a. lagringsutrymme. Logotypen var troligen f√∂r stor och togs bort ‚Äì f√∂rs√∂k med en mindre bild.", 8000);
        } catch (e2){
          console.error(e2);
          state.company.logoDataUrl = prev;
          showToast("Kunde inte spara data till webbl√§sarens lagring. Se konsolen f√∂r detaljer.", 8000);
        }
      } else {
        showToast("Kunde inte spara data till webbl√§sarens lagring. Se konsolen f√∂r detaljer.", 8000);
      }
    }

    try { renderAll(); } catch (e){ console.error(e); }
    try { scheduleFileAutosave(); } catch (e){ console.error(e); }
    return persisted;
  }

  // --- Fil-synk (Drive-synkad mapp) ---
  // OBS: Om hela UI:t "d√∂r" beror det n√§stan alltid p√• att scriptet inte kan parsas
  // (SyntaxError). Den h√§r sektionen √§r avsiktligt skriven utan dubletter/konstiga block.

  function fsApiSupported(){
    return !!(window.showOpenFilePicker && window.showSaveFilePicker && window.isSecureContext);
  }

  function setFsStatus(kind, text){
    if (!fsStatus) return;
    fsStatus.className = "status " + (kind === "ok" ? "ok" : "bad");
    fsStatus.textContent = text;
  }

  function setEditingLocked(locked){
    // Lock core editing actions if user requires a file but none is connected.
    const ids = [
      "btnNewVoucher","btnAddLine","btnClearVoucher","btnSaveVoucher",
      "btnAddAccount",
      "btnAddYear","btnCarry",
      "btnWipe"
    ];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = !!locked;
    });

    // Disable important fields
    const fields = ["vDate","vSeries","vNo","vText","vSign","aNo","aName","aType","fyStart","fyEnd"]; 
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = !!locked;
    });

    if (locked) setFsStatus("bad", "V√§lj/Skapa datafil f√∂r att b√∂rja");
  }

  function updateFsUI(){
    if (!fsStatus) return;

    // checkboxes
    if (fsAutosave){
      fsAutosave.checked = !!(state.fileSync && state.fileSync.autosave);
      fsAutosave.disabled = !fsApiSupported();
    }
    if (fsRequireFile){
      fsRequireFile.checked = !!(state.fileSync && state.fileSync.requireFile);
      // Important: never disable this checkbox.
      // Otherwise users can get locked out (buttons disabled) when opening the app in
      // a context where the File System Access API isn't available (e.g. file://).
      fsRequireFile.disabled = false;
    }

    const connected = !!fsHandle;
    if (btnLoadFromFile) btnLoadFromFile.disabled = !connected;
    if (btnSaveToFile) btnSaveToFile.disabled = !connected;
    if (btnDisconnectFile) btnDisconnectFile.disabled = !connected;

    const requireFile = !!(state.fileSync && state.fileSync.requireFile);

    if (!fsApiSupported()){
      setFsStatus("bad", requireFile ? "Kr√§ver HTTPS/localhost + Chrome/Edge (fil kr√§vs)" : "Kr√§ver HTTPS/localhost + Chrome/Edge");
      setEditingLocked(requireFile);
      return;
    }

    if (!connected){
      setFsStatus("bad", requireFile ? "Inte ansluten ¬∑ kr√§ver datafil" : "Inte ansluten");
      setEditingLocked(requireFile);
      return;
    }

    const name = fsHandle && fsHandle.name ? fsHandle.name : "(fil)";
    if (fsLastError){
      setFsStatus("bad", `${name} ¬∑ fel`);
    } else if (fsLastSavedAt){
      setFsStatus("ok", `${name} ¬∑ sparad ${fsLastSavedAt}`);
    } else {
      setFsStatus("ok", `${name} ¬∑ ansluten`);
    }

    setEditingLocked(false);
  }

  async function fsEnsurePermission(request){
    if (!fsHandle) return false;
    const opts = { mode: "readwrite" };
    try {
      const q = await fsHandle.queryPermission(opts);
      if (q === "granted") return true;
      if (!request) return false;
      const r = await fsHandle.requestPermission(opts);
      return r === "granted";
    } catch (e){
      fsLastError = e;
      updateFsUI();
      return false;
    }
  }

  async function fsWriteState(){
    if (!fsHandle) throw new Error("Ingen fil ansluten");
    const ok = await fsEnsurePermission(false);
    if (!ok) throw new Error("Ingen beh√∂righet (klicka 'Spara nu' f√∂r att till√•ta)");

    const writable = await fsHandle.createWritable();
    await writable.write(JSON.stringify(state, null, 2));
    await writable.close();

    fsLastSavedAt = new Date().toLocaleString("sv-SE", { hour12:false });
    fsLastError = null;
    updateFsUI();
  }

  async function fsLoadState(){
    if (!fsHandle) throw new Error("Ingen fil ansluten");
    const ok = await fsEnsurePermission(true);
    if (!ok) throw new Error("Beh√∂righet nekad");

    const file = await fsHandle.getFile();
    const txt = await file.text();
    if (!txt.trim()) throw new Error("Filen √§r tom");

    const d = JSON.parse(txt);
    if (!d || typeof d !== "object" || !Array.isArray(d.fiscalYears) || !d.accounts || !Array.isArray(d.vouchers)){
      throw new Error("Filen ser inte ut som en backup fr√•n appen");
    }

    state = d;
    // migration defaults
    if (!state.company) state.company = defaultData().company;
    { const cdef = defaultData().company; state.company = state.company || {}; for (const k of Object.keys(cdef)) if (state.company[k] == null) state.company[k] = cdef[k]; }
    if (!state.features) state.features = { sruEnabled: false };
    if (typeof state.features.sruEnabled !== "boolean") state.features.sruEnabled = false;
    if (!state.fileSync) state.fileSync = { autosave: true, requireFile: false };
    if (typeof state.fileSync.requireFile !== "boolean") state.fileSync.requireFile = false;

    // Auto-repair corrupted kontonamn via standardlista (utan SIE)
    try { if (typeof applyStdAccountsMapRepair === "function") applyStdAccountsMapRepair({ onlyReplacement: true }); } catch (e){ console.error(e); }

    save();
  }

  async function fsDisconnect(){
    fsHandle = null;
    fsLastError = null;
    fsLastSavedAt = null;
    await idbDel("dataFileHandle");
    updateFsUI();
  }

  async function fsConnectExisting(){
    if (!fsApiSupported()) return showToast("Fil-synk kr√§ver Chrome/Edge och secure context (HTTPS eller localhost).", 6500);
    try {
      const picked = await window.showOpenFilePicker({
        multiple: false,
        types: [{ description: "Bokf√∂ringsdata (JSON)", accept: { "application/json": [".json"] } }]
      });
      const handle = picked && picked[0] ? picked[0] : null;
      if (!handle) return;

      fsHandle = handle;
      await idbSet("dataFileHandle", fsHandle);
      fsLastError = null;
      fsLastSavedAt = null;

      // Ask permission now (user click), and auto-load if possible
      const ok = await fsEnsurePermission(true);
      if (ok){
        try { await fsLoadState(); } catch { /* empty/invalid => ignore */ }
      }

      updateFsUI();
    } catch (e){
      if (e && e.name === "AbortError") return;
      fsLastError = e;
      updateFsUI();
      showToast("Kunde inte v√§lja fil. √Ñr du p√• HTTPS/localhost och i Chrome/Edge?", 6500);
    }
  }

  async function fsCreateNew(){
    if (!fsApiSupported()) return showToast("Fil-synk kr√§ver Chrome/Edge och secure context (HTTPS eller localhost).", 6500);
    try {
      const handle = await window.showSaveFilePicker({
        suggestedName: "bokforing.json",
        types: [{ description: "Bokf√∂ringsdata (JSON)", accept: { "application/json": [".json"] } }]
      });
      if (!handle) return;

      fsHandle = handle;
      await idbSet("dataFileHandle", fsHandle);
      fsLastError = null;
      fsLastSavedAt = null;
      updateFsUI();

      // write initial
      const ok = await fsEnsurePermission(true);
      if (ok){
        const writable = await fsHandle.createWritable();
        await writable.write(JSON.stringify(state, null, 2));
        await writable.close();
        fsLastSavedAt = new Date().toLocaleString("sv-SE", { hour12:false });
        updateFsUI();
      }
    } catch (e){
      if (e && e.name === "AbortError") return;
      fsLastError = e;
      updateFsUI();
      showToast("Kunde inte skapa fil. √Ñr du p√• HTTPS/localhost och i Chrome/Edge?", 6500);
    }
  }

  function scheduleFileAutosave(){
    if (!fsApiSupported()) return;
    if (!fsHandle) return;
    if (!state.fileSync || !state.fileSync.autosave) return;

    if (fsAutosaveTimer) clearTimeout(fsAutosaveTimer);
    fsAutosaveTimer = setTimeout(async ()=>{
      try {
        // Only autosave if permission is already granted (no prompts without click)
        const ok = await fsEnsurePermission(false);
        if (!ok) return;
        await fsWriteState();
      } catch (e){
        fsLastError = e;
        updateFsUI();
      }
    }, 600);
  }

  // --- State ---
  let state = load();
  let editingVoucherId = null;
  let correctionOfId = null;

  // File sync handle (stored in IndexedDB, not in state)
  let fsHandle = null;
  let fsLastSavedAt = null;
  let fsLastError = null;
  let fsAutosaveTimer = null;

  // --- DOM ---
  const tabs = Array.from(document.querySelectorAll(".tab[data-tab]"));
  const sections = {
    vouchers: document.getElementById("tab-vouchers"),
    accounts: document.getElementById("tab-accounts"),
    reports: document.getElementById("tab-reports"),
    customers: document.getElementById("tab-customers"),
    suppliers: document.getElementById("tab-suppliers"),
    invoices: document.getElementById("tab-invoices"),
    export: document.getElementById("tab-export"),
    settings: document.getElementById("tab-settings"),
    sru: document.getElementById("tab-sru"),
  };

  const companyNameEl = document.getElementById("companyName");
  const yearPillSelect = document.getElementById("yearPillSelect");

  const yearSelect = document.getElementById("yearSelect");
  const voucherList = document.getElementById("voucherList");

  const vDate = document.getElementById("vDate");
  const vSeries = document.getElementById("vSeries");
  const vNo = document.getElementById("vNo");
  const vText = document.getElementById("vText");
  const vSign = document.getElementById("vSign");
  const linesTbody = document.getElementById("linesTbody");
  const balanceBadge = document.getElementById("balanceBadge");
  const btnFillExample = document.getElementById("btnFillExample");
  const btnNewVoucher = document.getElementById("btnNewVoucher");
  const btnAddLine = document.getElementById("btnAddLine");
  const btnClearVoucher = document.getElementById("btnClearVoucher");
  const btnSaveVoucher = document.getElementById("btnSaveVoucher");
  const btnRefresh = document.getElementById("btnRefresh");

  const aNo = document.getElementById("aNo");
  const aName = document.getElementById("aName");
  const aType = document.getElementById("aType");
  const accountsTbody = document.getElementById("accountsTbody");
  const accountSearch = document.getElementById("accountSearch");
  const btnAddAccount = document.getElementById("btnAddAccount");
  const btnResetDemo = document.getElementById("btnResetDemo");
  const btnFixChars = document.getElementById("btnFixChars");
  const stdAccountsFile = document.getElementById("stdAccountsFile");
  // Reports (Rapportgenerator)
  const rptYearSelect = document.getElementById("rptYearSelect");
  const rptFrom = document.getElementById("rptFrom");
  const rptTo = document.getElementById("rptTo");
  const rptType = document.getElementById("rptType");
  const btnRptGenerate = document.getElementById("btnRptGenerate");
  const btnRptPrint = document.getElementById("btnRptPrint");
  const btnRptCsv = document.getElementById("btnRptCsv");
  const btnRptXls = document.getElementById("btnRptXls");
  const reportOutput = document.getElementById("reportOutput");
  const btnRptFullYear = document.getElementById("btnRptFullYear");
  const btnRptThisMonth = document.getElementById("btnRptThisMonth");
  const btnRptThisQuarter = document.getElementById("btnRptThisQuarter");

  // Last generated report (HTML fragment)
  let lastReportHtml = "";
  let lastReportTitle = "";

  const sieYearSelect = document.getElementById("sieYearSelect");
  const btnExportSie4 = document.getElementById("btnExportSie4");
  const btnExportJson = document.getElementById("btnExportJson");
  const jsonImport = document.getElementById("jsonImport");
  const btnWipe = document.getElementById("btnWipe");
  // Arkivering
  const archiveYearSelect = document.getElementById("archiveYearSelect");
  const btnMakeArchive = document.getElementById("btnMakeArchive");
  const archiveImportJson = document.getElementById("archiveImportJson");
  const archiveImportSha = document.getElementById("archiveImportSha");
  const btnVerifyArchive = document.getElementById("btnVerifyArchive");
  const archiveVerifyResult = document.getElementById("archiveVerifyResult");


  // SIE import
  const sieImportFile = document.getElementById("sieImportFile");
  const btnImportSie = document.getElementById("btnImportSie");
  const sieImportEncoding = document.getElementById("sieImportEncoding");
  const sieImportWipe = document.getElementById("sieImportWipe");

  // File sync (Drive-synkad mapp via File System Access API)
  const btnConnectFile = document.getElementById("btnConnectFile");
  const btnCreateFile = document.getElementById("btnCreateFile");
  const btnLoadFromFile = document.getElementById("btnLoadFromFile");
  const btnSaveToFile = document.getElementById("btnSaveToFile");
  const btnDisconnectFile = document.getElementById("btnDisconnectFile");
  const fsAutosave = document.getElementById("fsAutosave");
  const fsRequireFile = document.getElementById("fsRequireFile");
  const fsStatus = document.getElementById("fsStatus");

  const sCompany = document.getElementById("sCompany");
  const sOrgnr = document.getElementById("sOrgnr");
  const sCurrency = document.getElementById("sCurrency");
  const sSign = document.getElementById("sSign");
  const sAddr = document.getElementById("sAddr");
  const sZip = document.getElementById("sZip");
  const sCity = document.getElementById("sCity");
  const sCountry = document.getElementById("sCountry");
  const sEmail = document.getElementById("sEmail");
  const sPhone = document.getElementById("sPhone");
  const sWeb = document.getElementById("sWeb");
  const sVat = document.getElementById("sVat");
  const sPayDays = document.getElementById("sPayDays");
  const sBg = document.getElementById("sBg");
  const sPg = document.getElementById("sPg");
  const sSwish = document.getElementById("sSwish");
  const sBankAccount = document.getElementById("sBankAccount");
  const sIban = document.getElementById("sIban");
  const sSwift = document.getElementById("sSwift");
  const sInvNote = document.getElementById("sInvNote");
  const sInvFooter = document.getElementById("sInvFooter");
  const sSruEnabled = document.getElementById("sSruEnabled");
  const sLogo = document.getElementById("sLogo");
  const btnSaveSettings = document.getElementById("btnSaveSettings");
  const btnRemoveLogo = document.getElementById("btnRemoveLogo");
  const logoPreview = document.getElementById("logoPreview");

  function renderLogoPreview(){
    if (!logoPreview) return;
    const url = state?.company?.logoDataUrl;
    if (!url){
      logoPreview.textContent = "Ingen logotyp vald.";
      return;
    }
    logoPreview.innerHTML = `<img alt="Logotyp" src="${url}" style="max-height:48px; max-width:180px; vertical-align:middle;" />`;
  }

  function renderSettings(){
    state.company = state.company || defaultData().company;
    state.features = state.features || { sruEnabled: false };

    if (sCompany) sCompany.value = state.company.name || "";
    if (sOrgnr) sOrgnr.value = state.company.orgnr || "";
    if (sCurrency) sCurrency.value = state.company.currency || "SEK";
    if (sSign) sSign.value = state.company.defaultSign || "";

    if (sAddr) sAddr.value = state.company.addr || "";
    if (sZip) sZip.value = state.company.zip || "";
    if (sCity) sCity.value = state.company.city || "";
    if (sCountry) sCountry.value = state.company.country || "";

    if (sEmail) sEmail.value = state.company.email || "";
    if (sPhone) sPhone.value = state.company.phone || "";
    if (sWeb) sWeb.value = state.company.web || "";
    if (sVat) sVat.value = state.company.vat || "";
    if (sPayDays) sPayDays.value = String(state.company.payDays ?? 30);

    if (sBg) sBg.value = state.company.bankgiro || "";
    if (sPg) sPg.value = state.company.plusgiro || "";
    if (sSwish) sSwish.value = state.company.swishPhone || "";
    if (sBankAccount) sBankAccount.value = state.company.bankAccountNo || "";
    if (sIban) sIban.value = state.company.iban || "";
    if (sSwift) sSwift.value = state.company.swift || "";

    if (sInvNote) sInvNote.value = state.company.invoiceNote || "";
    if (sInvFooter) sInvFooter.value = state.company.invoiceFooter || "";

    if (sSruEnabled) sSruEnabled.checked = !!state.features.sruEnabled;

    if (companyNameEl) companyNameEl.textContent = state.company.name || "FU-BOOKKEEPING";
    renderLogoPreview();
    try { updateFsUI(); } catch (e){ console.error(e); }
  }

  function saveSettings(){
    state.company = state.company || defaultData().company;
    state.features = state.features || { sruEnabled: false };

    const payDaysRaw = (sPayDays?.value || "").trim();
    const payDays = parseInt(payDaysRaw, 10);

    state.company.name = (sCompany?.value || "").trim();
    state.company.orgnr = (sOrgnr?.value || "").trim();
    state.company.currency = (sCurrency?.value || "SEK").trim() || "SEK";
    state.company.defaultSign = (sSign?.value || "").trim();

    state.company.addr = (sAddr?.value || "").trim();
    state.company.zip = (sZip?.value || "").trim();
    state.company.city = (sCity?.value || "").trim();
    state.company.country = (sCountry?.value || "").trim();

    state.company.email = (sEmail?.value || "").trim();
    state.company.phone = (sPhone?.value || "").trim();
    state.company.web = (sWeb?.value || "").trim();
    state.company.vat = (sVat?.value || "").trim();
    state.company.payDays = Number.isFinite(payDays) && payDays > 0 ? payDays : 30;

    state.company.bankgiro = (sBg?.value || "").trim();
    state.company.plusgiro = (sPg?.value || "").trim();
    state.company.swishPhone = (sSwish?.value || "").trim();
    state.company.bankAccountNo = (sBankAccount?.value || "").trim();
    state.company.iban = (sIban?.value || "").trim();
    state.company.swift = (sSwift?.value || "").trim();

    state.company.invoiceNote = (sInvNote?.value || "").trim();
    state.company.invoiceFooter = (sInvFooter?.value || "").trim();

    state.features.sruEnabled = !!(sSruEnabled && sSruEnabled.checked);

    if (companyNameEl) companyNameEl.textContent = state.company.name || "FU-BOOKKEEPING";
    const ok = save();
    if (ok) showToast("Dina inst√§llningar √§r sparade");
  }

  const fyStart = document.getElementById("fyStart");
  const fyEnd = document.getElementById("fyEnd");
  const yearsTbody = document.getElementById("yearsTbody");

  // SRU tab
  const sruLockedBox = document.getElementById("sruLockedBox");
  const sruStatusText = document.getElementById("sruStatusText");
  const btnSruExport = document.getElementById("btnSruExport");
  const carryFrom = document.getElementById("carryFrom");
  const carryTo = document.getElementById("carryTo");

  // Period lock
  const lockYear = document.getElementById("lockYear");
  const lockUntil = document.getElementById("lockUntil");
  const btnSetLock = document.getElementById("btnSetLock");
  const btnClearLock = document.getElementById("btnClearLock");


  // --- Tab logic (single delegated handler; avoids overlay/propagation edge-cases) ---
  const sidebar = document.querySelector(".sidebar");

  function setActiveYear(yearId){
    const yid = (yearId || "").trim();
    if (!yid) return;
    state.activeYearId = yid;
    save();
    try { fillYearSelectors(); } catch (e){ console.error(e); }
    try { if (typeof renderVouchers === "function") renderVouchers(); } catch (e){ console.error(e); }
    try { if (typeof renderInvoices === "function") renderInvoices(); } catch (e){ console.error(e); }
  }

  function safeUiCall(fn){
    try { if (typeof fn === "function") fn(); }
    catch (err) { console.error(err); }
  }

  function activateTab(tabKey){
    if (!tabKey) return;

    tabs.forEach(b => b.classList.remove("active"));
    const btn = tabs.find(b => (b.dataset && b.dataset.tab) === tabKey);
    if (btn) btn.classList.add("active");

    Object.entries(sections).forEach(([k, el]) => {
      if (el) el.hidden = (k !== tabKey);
    });

    // Lazy renders
    if (tabKey === "reports") safeUiCall(typeof renderReports === "function" ? renderReports : null);
    if (tabKey === "accounts") safeUiCall(typeof renderAccounts === "function" ? renderAccounts : null);
    if (tabKey === "invoices") safeUiCall(typeof renderInvoices === "function" ? renderInvoices : null);
    if (tabKey === "customers") safeUiCall(typeof renderCustomers === "function" ? renderCustomers : null);
    if (tabKey === "suppliers") safeUiCall(typeof renderSuppliers === "function" ? renderSuppliers : null);
    if (tabKey === "settings") safeUiCall(typeof renderSettings === "function" ? renderSettings : null);
  }

  if (sidebar){
    sidebar.addEventListener("click", (e)=>{
      const btn = e.target && e.target.closest ? e.target.closest("button.tab[data-tab]") : null;
      if (!btn) return;
      e.preventDefault();
      activateTab(btn.dataset.tab);
    });

    // Keyboard (Enter/Space) on focused tab buttons
    sidebar.addEventListener("keydown", (e)=>{
      if (e.key !== "Enter" && e.key !== " ") return;
      const btn = e.target && e.target.closest ? e.target.closest("button.tab[data-tab]") : null;
      if (!btn) return;
      e.preventDefault();
      activateTab(btn.dataset.tab);
    });
  }

  // Global fallbacks: if any overlay/grid bug blocks clicks on tabs, still switch.
  document.addEventListener("click", (e)=>{
    const el = e.target && e.target.closest ? e.target.closest(".tab[data-tab]") : null;
    if (!el) return;
    e.preventDefault();
    activateTab(el.dataset.tab);
  }, true);

  document.addEventListener("pointerdown", (e)=>{
    if (!document.elementsFromPoint) return;
    const els = document.elementsFromPoint(e.clientX, e.clientY) || [];
    const btn = els.find(x => x && x.classList && x.classList.contains("tab") && x.dataset && x.dataset.tab);
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();
    activateTab(btn.dataset.tab);
  }, true);

  document.addEventListener("keydown", (e)=>{
    if (e.key !== "Enter" && e.key !== " ") return;
    const el = document.activeElement;
    const btn = el && el.closest ? el.closest(".tab[data-tab]") : null;
    if (!btn) return;
    e.preventDefault();
    activateTab(btn.dataset.tab);
  }, true);



  // Ensure initial tab is consistent with markup (first .tab.active)
  const initial = (tabs.find(b => b.classList.contains("active"))?.dataset?.tab) || "vouchers";
  activateTab(initial);

  // Keep year selectors in sync (top pill <-> vouchers list)
  if (yearPillSelect){
    yearPillSelect.addEventListener("change", ()=> setActiveYear(yearPillSelect.value));
  }
  if (yearSelect){
    yearSelect.addEventListener("change", ()=> setActiveYear(yearSelect.value));
  }

  // --- Accounts helpers ---

  function accountLabel(no){
    const a = state.accounts[no];
    return a ? `${no} ‚Äì ${a.name}` : `${no} ‚Äì (ok√§nt konto)`;
  }

  function guessTypeFromAccountNo(no){
    const first = String(no)[0];
    if (first === "1") return "asset";
    if (first === "2") return "liability";
    if (first === "3") return "income";
    if (["4","5","6","7","8"].includes(first)) return "expense";
    return "other";
  }

  function accountTypeLabel(t){
    if (t === "asset") return "Tillg√•ng";
    if (t === "liability") return "EK/skuld";
    if (t === "income") return "Int√§kt";
    if (t === "expense") return "Kostnad";
    return "√ñvrigt";
  }

  function normalizeAccountNo(no){
    return String(no || "").trim();
  }

  function fixMojibake(s){
    // Common UTF-8-as-Latin1 sequences
    let out = String(s ?? "")
      .replaceAll("√É¬•", "√•")
      .replaceAll("√É¬§", "√§")
      .replaceAll("√É¬∂", "√∂")
      .replaceAll("√É‚Ä¶", "√Ö")
      .replaceAll("√É‚Äû", "√Ñ")
      .replaceAll("√É‚Äì", "√ñ")
      .replaceAll("√¢‚Ç¨‚Äú", "‚Äì")
      .replaceAll("√¢‚Ç¨‚Äù", "‚Äî")
      .replaceAll("√¢‚Ç¨", "‚Äú")
      .replaceAll("√¢‚Ç¨\u009d", "‚Äù")
      .replaceAll("√¢‚Ç¨\u0099", "‚Äô")
      .replaceAll("√¢‚Ç¨\u0098", "‚Äò")
      .replaceAll("√¢‚Ç¨¬¢", "‚Ä¢")
      .replaceAll("√Ç ", " ");

    // If the original bytes were already lost and replaced with U+FFFD ("ÔøΩ"),
    // we can't recover generally. But we can fix a few very common Swedish patterns.
    // Example: "FÔøΩrlagsinsatser" -> "F√∂rlagsinsatser".
    out = out
      .replace(/F\uFFFDrl/g, "F√∂rl")
      .replace(/f\uFFFDrl/g, "f√∂rl")
      .replace(/F\uFFFDretag/g, "F√∂retag")
      .replace(/f\uFFFDretag/g, "f√∂retag")
      .replace(/F\uFFFDrs√§lj/g, "F√∂rs√§lj")
      .replace(/f\uFFFDrs√§lj/g, "f√∂rs√§lj")
      .replace(/\bF\uFFFDrlags\b/g, "F√∂rlags")
      .replace(/\b(f)\uFFFDr\b/g, "$1√∂r")
      .replace(/\bF\uFFFDr\b/g, "F√∂r");

    return out;
  }

  const STD_ACCOUNTS_KEY = "FU_STD_ACCOUNTS_MAP_V1";

  function loadStdAccountsMap(){
    try {
      const raw = localStorage.getItem(STD_ACCOUNTS_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return (obj && typeof obj === "object") ? obj : null;
    } catch {
      return null;
    }
  }
  function saveStdAccountsMap(map){
    try {
      localStorage.setItem(STD_ACCOUNTS_KEY, JSON.stringify(map || {}));
      return true;
    } catch (e){
      console.error(e);
      return false;
    }
  }

  function normalizeStdAccountsMap(map){
    const out = {};
    if (!map) return out;
    if (Array.isArray(map)){
      for (const it of map){
        if (!it) continue;
        const no = String(it.no ?? it.account ?? it.konto ?? it.nr ?? "").trim();
        const name = String(it.name ?? it.namn ?? it.title ?? "").trim();
        if (no && name) out[no] = name;
      }
      return out;
    }
    if (typeof map === "object"){
      for (const k of Object.keys(map)){
        const v = map[k];
        const no = String(k || "").trim();
        const name = (typeof v === "string") ? v : (v && typeof v === "object" ? String(v.name ?? v.namn ?? "").trim() : "");
        if (no && name) out[no] = name;
      }
    }
    return out;
  }

  function parseStdAccountsText(txt){
    const s = String(txt || "").trim();
    if (!s) return {};
    // JSON object/array support
    if (s.startsWith("{") || s.startsWith("[")){
      const obj = JSON.parse(s);
      return normalizeStdAccountsMap(obj);
    }

    // CSV / TXT: konto;namn or konto,namn or tab
    const out = {};
    const lines = s.split(/\r?\n/);
    for (const raw of lines){
      const line = raw.trim();
      if (!line) continue;
      if (line.startsWith("#")) continue;
      // detect delimiter
      const delim = line.includes(";") ? ";" : (line.includes("\t") ? "\t" : ",");
      const parts = line.split(delim);
      if (parts.length < 2) continue;
      const no = String(parts[0] || "").trim().replace(/^"|"$/g, "");
      const name = String(parts.slice(1).join(delim) || "").trim().replace(/^"|"$/g, "");
      if (!no || !name) continue;
      // skip header rows
      const low = no.toLowerCase();
      if (low === "konto" || low === "account" || low === "nr") continue;
      out[no] = name;
    }
    return out;
  }

  function applyStdAccountsMapRepair(opts){
    const onlyReplacement = (opts && typeof opts.onlyReplacement === "boolean") ? opts.onlyReplacement : true;
    const stdMap = loadStdAccountsMap();
    if (!stdMap) return { updated: 0 };

    state.accounts = state.accounts || {};
    let updated = 0;
    for (const no of Object.keys(state.accounts)){
      const a = state.accounts[no];
      if (!a) continue;
      const curName = String(a.name || "");
      if (onlyReplacement && !curName.includes("\uFFFD")) continue;

      const stdName = stdMap[String(no)] || stdMap[String(no).trim()];
      if (!stdName) continue;

      const nextName = String(stdName);
      if (curName !== nextName){
        a.name = nextName;
        updated++;
      }
      if (!a.type) a.type = guessTypeFromAccountNo(no);
    }
    return { updated };
  }

  function countReplacementChars(s){
    // U+FFFD replacement character means decoding already lost information.
    return (String(s ?? "").match(/\uFFFD/g) || []).length;
  }

  function decodeWithBestEncoding(buf, preferredEncoding){
    const preferred = String(preferredEncoding || "utf-8").trim() || "utf-8";
    const candidates = [preferred, "windows-1252", "ibm437", "utf-8"].filter((v, i, a)=> a.indexOf(v) === i);
    let best = { enc: preferred, text: "", bad: Number.POSITIVE_INFINITY };
    for (const enc of candidates){
      try {
        const text = new TextDecoder(enc).decode(buf);
        const bad = countReplacementChars(text);
        if (bad < best.bad){
          best = { enc, text, bad };
          if (bad === 0) break;
        }
      } catch (e){
        // ignore unsupported encodings
      }
    }
    return best;
  }

  function extractAccountsFromSieText(txt){
    const imported = {};
    const lines = String(txt || "").split(/\r?\n/);
    for (const rawLine of lines){
      const line = rawLine.trim();
      if (!line || !line.startsWith("#")) continue;
      if (!line.startsWith("#KONTO")) continue;
      const t = sieTokens(line);
      if (t[0] !== "#KONTO" || t.length < 3) continue;
      const acc = String(t[1] || "").trim();
      const name = String(t[2] || "").trim();
      if (acc) imported[acc] = name;
    }
    return imported;
  }

  async function repairAccountNamesFromSieFile(file, preferredEncoding){
    if (!file) return { updated: 0, added: 0, encoding: "", bad: 0 };
    const buf = await file.arrayBuffer();
    const dec = decodeWithBestEncoding(buf, preferredEncoding);
    const imported = extractAccountsFromSieText(dec.text);

    state.accounts = state.accounts || {};
    let updated = 0;
    let added = 0;
    for (const acc of Object.keys(imported)){
      const name = imported[acc];
      if (state.accounts[acc]){
        if (String(state.accounts[acc].name || "") !== name){
          state.accounts[acc].name = name;
          updated++;
        }
        if (!state.accounts[acc].type) state.accounts[acc].type = guessTypeFromAccountNo(acc);
      } else {
        state.accounts[acc] = { name, type: guessTypeFromAccountNo(acc) };
        added++;
      }
    }

    return { updated, added, encoding: dec.enc, bad: dec.bad };
  }

  function renderAccounts(){
    if (!accountsTbody) return;
    state.accounts = state.accounts || {};

    const q = (accountSearch && accountSearch.value ? String(accountSearch.value) : "").trim().toLowerCase();
    const rows = Object.keys(state.accounts)
      .map(no => ({ no, meta: state.accounts[no] || {} }))
      .filter(r => {
        const name = String(r.meta.name || "").toLowerCase();
        if (!q) return true;
        return String(r.no).toLowerCase().includes(q) || name.includes(q);
      })
      .sort((a,b)=> String(a.no).localeCompare(String(b.no), "sv"));

    accountsTbody.innerHTML = "";
    if (!rows.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 4;
      td.className = "muted small";
      td.textContent = q ? "Inga matchande konton." : "Inga konton √§nnu. L√§gg till ett konto eller √•terst√§ll demo-kontoplan.";
      tr.appendChild(td);
      accountsTbody.appendChild(tr);
      return;
    }

    rows.forEach(r=>{
      const meta = r.meta || {};
      const tr = document.createElement("tr");

      const tdNo = document.createElement("td");
      tdNo.textContent = String(r.no);

      const tdName = document.createElement("td");
      tdName.textContent = String(meta.name || "");

      const tdType = document.createElement("td");
      tdType.textContent = accountTypeLabel(meta.type || guessTypeFromAccountNo(r.no));

      const tdAct = document.createElement("td");
      const btnDel = document.createElement("button");
      btnDel.type = "button";
      btnDel.className = "btn danger";
      btnDel.textContent = "Ta bort";
      btnDel.dataset.act = "del";
      btnDel.dataset.no = String(r.no);
      tdAct.appendChild(btnDel);

      tr.appendChild(tdNo);
      tr.appendChild(tdName);
      tr.appendChild(tdType);
      tr.appendChild(tdAct);
      accountsTbody.appendChild(tr);
    });
  }

  let accountsWired = false;
  function wireAccountEvents(){
    if (accountsWired) return;
    accountsWired = true;

    if (btnAddAccount){
      btnAddAccount.addEventListener("click", (e)=>{
        e.preventDefault();
        const no = normalizeAccountNo(aNo && aNo.value);
        const name = String(aName && aName.value ? aName.value : "").trim();
        if (!no) return showToast("Ange kontonummer.", 3500);
        if (!name) return showToast("Ange kontonamn.", 3500);

        state.accounts = state.accounts || {};
        const type = (aType && aType.value) ? aType.value : guessTypeFromAccountNo(no);
        state.accounts[no] = { name, type };
        save();
        renderAccounts();

        // Refresh voucher editor account selects if visible
        try { if (typeof renderLines === "function") renderLines(); } catch {}

        if (aNo) aNo.value = "";
        if (aName) aName.value = "";
        if (aType) aType.value = guessTypeFromAccountNo(no);
        if (aNo) aNo.focus();
      });
    }

    if (accountSearch){
      accountSearch.addEventListener("input", ()=> renderAccounts());
    }

    if (btnResetDemo){
      btnResetDemo.addEventListener("click", async (e)=>{
        e.preventDefault();
        const ok = await confirmAsync("√Öterst√§ll demo-kontoplan? Detta skriver √∂ver din nuvarande kontoplan.", { okText:"√Öterst√§ll", cancelText:"Avbryt", okKind:"danger" });
        if (!ok) return;
        state.accounts = demoAccounts();
        save();
        renderAccounts();
        try { if (typeof renderLines === "function") renderLines(); } catch {}
        showToast("Demo-kontoplan √•terst√§lld.", 3500);
      });
    }

    if (btnFixChars){
      btnFixChars.addEventListener("click", async (e)=>{
        e.preventDefault();
        state.accounts = state.accounts || {};
        let changed = 0;
        let remainingReplacement = 0;
        let standardized = 0;
        let standardizedStd = 0;
        for (const no of Object.keys(state.accounts)){
          const a = state.accounts[no];
          if (!a) continue;
          const prev = String(a.name || "");
          const next = fixMojibake(prev);
          if (next !== prev){
            a.name = next;
            changed++;
          }
          if (String(a.name || "").includes("\uFFFD")) remainingReplacement++;
        }

        // If some names still contain U+FFFD and we have a known standardized name
        // (from our built-in minimal kontoplan), use that as a safe auto-correct.
        if (remainingReplacement){
          const std = demoAccounts();
          for (const no of Object.keys(state.accounts)){
            const a = state.accounts[no];
            if (!a || !String(a.name||"").includes("\uFFFD")) continue;
            if (std[no] && std[no].name){
              a.name = std[no].name;
              if (!a.type && std[no].type) a.type = std[no].type;
              standardized++;
            }
          }
          if (standardized){
            // re-count after standardization
            remainingReplacement = 0;
            for (const no of Object.keys(state.accounts||{})){
              const a = state.accounts[no];
              if (a && String(a.name||"").includes("\uFFFD")) remainingReplacement++;
            }
          }
        }

        // If U+FFFD still remains, try user-provided standard list (CSV/JSON)
        if (remainingReplacement){
          const stdMap = loadStdAccountsMap();
          if (stdMap){
            for (const no of Object.keys(state.accounts)){
              const a = state.accounts[no];
              if (!a || !String(a.name||"").includes("\uFFFD")) continue;
              const stdName = stdMap[String(no)] || stdMap[String(no).trim()];
              if (stdName){
                a.name = String(stdName);
                if (!a.type) a.type = guessTypeFromAccountNo(no);
                standardizedStd++;
              }
            }
            if (standardizedStd){
              remainingReplacement = 0;
              for (const no of Object.keys(state.accounts||{})){
                const a = state.accounts[no];
                if (a && String(a.name||"").includes("\uFFFD")) remainingReplacement++;
              }
            }
          }
        }

        // If U+FFFD remains, the real fix is to decode the ORIGINAL bytes correctly.
        // We can do that if user has selected the SIE file (Import/Export ‚Üí V√§lj SIE-fil).
        if (remainingReplacement && sieImportFile && sieImportFile.files && sieImportFile.files[0]){
          try {
            const res = await repairAccountNamesFromSieFile(
              sieImportFile.files[0],
              (sieImportEncoding && sieImportEncoding.value) || "utf-8"
            );
            // Re-count after SIE repair
            remainingReplacement = 0;
            for (const no of Object.keys(state.accounts||{})){
              const a = state.accounts[no];
              if (a && String(a.name||"").includes("\uFFFD")) remainingReplacement++;
            }

            save();
            renderAccounts();
            try { if (typeof renderLines === "function") renderLines(); } catch {}

            const msg = `Uppdaterade ${res.updated} kontonamn${res.added?` (+${res.added} nya konton)`:""} fr√•n SIE (${res.encoding}).`;
            if (remainingReplacement){
              showToast(msg + ` Obs: ${remainingReplacement} konton inneh√•ller fortfarande "ÔøΩ" (kan kr√§va annan encoding eller manuell √§ndring).`, 8000);
            } else {
              showToast(msg, 4500);
            }
            return;
          } catch (err){
            console.error(err);
            // fall through to normal save + message
          }
        }

        if (changed){
          save();
          renderAccounts();
          try { if (typeof renderLines === "function") renderLines(); } catch {}
          if (remainingReplacement){
            showToast(`Fixade tecken i ${changed} konton${standardized?` (+${standardized} standardiserade)`:""}${standardizedStd?` (+${standardizedStd} fr√•n standardlista)`:""}. F√∂r att reparera "ÔøΩ": g√• till Import/Export, v√§lj original SIE-fil, och klicka "Fixa √Ö√Ñ√ñ" igen (appen kan d√• l√§sa #KONTO med r√§tt encoding).`, 8000);
          } else {
            showToast(`Fixade tecken i ${changed} konton${standardized?` (+${standardized} standardiserade)`:""}${standardizedStd?` (+${standardizedStd} fr√•n standardlista)`:""}.`, 3500);
          }
        } else {
          if (remainingReplacement){
            showToast(`Hittade "ÔøΩ" i ${remainingReplacement} konton. F√∂r att fixa automatiskt: (1) v√§lj original SIE-fil under Import/Export, eller (2) ladda en Standardlista i Kontoplan och klicka "Fixa √Ö√Ñ√ñ" igen.`, 8000);
          } else {
            showToast("Inga teckenfel hittades.", 2500);
          }
        }
      });
    }

    if (stdAccountsFile){
      stdAccountsFile.addEventListener("change", async ()=>{
        const f = stdAccountsFile.files && stdAccountsFile.files[0];
        if (!f) return;
        try {
          const txt = await f.text();
          const map = parseStdAccountsText(txt);
          const keys = Object.keys(map);
          if (!keys.length){
            showToast("Standardlista: ingen data hittades (CSV/JSON).", 6500);
            return;
          }
          const ok = saveStdAccountsMap(map);
          if (!ok){
            showToast("Kunde inte spara standardlistan (localStorage).", 8000);
            return;
          }

          const r = applyStdAccountsMapRepair({ onlyReplacement: true });
          if (r.updated){
            save();
            showToast(`Standardlista laddad (${keys.length} konton). Reparerade ${r.updated} konton med "ÔøΩ".`, 8000);
          } else {
            showToast(`Standardlista laddad (${keys.length} konton). Inga konton med "ÔøΩ" matchade listan.`, 8000);
          }
        } catch (err){
          console.error(err);
          showToast("Standardlista: kunde inte l√§sa filen. Prova CSV (konto;namn) eller JSON.", 8000);
        } finally {
          stdAccountsFile.value = "";
        }
      });
    }

    if (accountsTbody){
      accountsTbody.addEventListener("click", async (e)=>{
        const b = e.target && e.target.closest ? e.target.closest("button[data-act]") : null;
        if (!b) return;
        const act = b.dataset.act;
        const no = b.dataset.no;
        if (act !== "del" || !no) return;

        // Warn if used in vouchers
        const used = (state.vouchers || []).some(v => (v.lines || []).some(l => String(l.account) === String(no)));
        const msg = used
          ? `Kontot ${no} anv√§nds i verifikationer. Ta bort √§nd√•? (Det kommer visas som "ok√§nt konto" i historik.)`
          : `Ta bort konto ${no}?`;
        if (!(await confirmAsync(msg, { okText:"Ta bort", cancelText:"Avbryt", okKind:"danger" }))) return;
        delete state.accounts[no];
        save();
        renderAccounts();
        try { if (typeof renderLines === "function") renderLines(); } catch {}
      });
    }
  }

  // --- Invoice helpers ---
  const invYearSelect = document.getElementById("invYearSelect");
  const invoiceList = document.getElementById("invoiceList");
  const invDate = document.getElementById("invDate");
  const invDue = document.getElementById("invDue");
  const invNo = document.getElementById("invNo");
  const invRef = document.getElementById("invRef");
  const invCustomerBox = document.getElementById("invCustomerBox");
  const invLinesTbody = document.getElementById("invLinesTbody");
  const invTotal = document.getElementById("invTotal");
  const invRounding = document.getElementById("invRounding");
  const btnInvNew = document.getElementById("btnInvNew");
  const btnInvSave = document.getElementById("btnInvSave");
  const btnInvClear = document.getElementById("btnInvClear");
  const btnInvAddItem = document.getElementById("btnInvAddItem");
  const btnInvAddComment = document.getElementById("btnInvAddComment");
  const btnInvPickCustomer = document.getElementById("btnInvPickCustomer");
  const btnInvPrint = document.getElementById("btnInvPrint");
  const btnInvToVoucher = document.getElementById("btnInvToVoucher");
  const btnInvRefresh = document.getElementById("btnInvRefresh");

  const customerDialog = document.getElementById("customerDialog");
  const btnCustomerClose = document.getElementById("btnCustomerClose");
  const btnCustomerSave = document.getElementById("btnCustomerSave");
  const customerList = document.getElementById("customerList");
  const custName = document.getElementById("custName");
  const custAddr = document.getElementById("custAddr");
  const custEmail = document.getElementById("custEmail");
  const custOrgnr = document.getElementById("custOrgnr");
  // Customer registry (tab)
  const custEditId = document.getElementById("custEditId");
  const custRegName = document.getElementById("custRegName");
  const custRegAddr = document.getElementById("custRegAddr");
  const custRegEmail = document.getElementById("custRegEmail");
  const custRegOrgnr = document.getElementById("custRegOrgnr");
  const custSearch = document.getElementById("custSearch");
  const customersList = document.getElementById("customersList");
  const btnCustNew = document.getElementById("btnCustNew");
  const btnCustSave = document.getElementById("btnCustSave");
  const btnCustRefresh = document.getElementById("btnCustRefresh");

  // Supplier registry (tab)
  const supEditId = document.getElementById("supEditId");
  const supRegName = document.getElementById("supRegName");
  const supRegAddr = document.getElementById("supRegAddr");
  const supRegEmail = document.getElementById("supRegEmail");
  const supRegOrgnr = document.getElementById("supRegOrgnr");
  const supRegPayout = document.getElementById("supRegPayout");
  const supSearch = document.getElementById("supSearch");
  const suppliersList = document.getElementById("suppliersList");
  const btnSupNew = document.getElementById("btnSupNew");
  const btnSupSave = document.getElementById("btnSupSave");
  const btnSupRefresh = document.getElementById("btnSupRefresh");


  let editingInvoiceId = null;
  let invCustomerId = null;
  let invLines = [];

  function addDays(dateIso, days){
    const d = new Date(dateIso + "T00:00:00");
    d.setDate(d.getDate() + days);
    const pad = (n)=> String(n).padStart(2,"0");
    return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate());
  }

  function nextInvoiceNo(yearId){
    const nums = (state.invoices||[])
      .filter(i => i.yearId === yearId)
      .map(i => Number(i.no))
      .filter(n => Number.isFinite(n));
    const max = nums.length ? Math.max(...nums) : 1000;
    return String(max + 1);
  }

  function newInvoice(){
    editingInvoiceId = null;
    invCustomerId = null;
    invDate.value = todayISO();
    invDue.value = addDays(invDate.value, (state.company.payDays||30));
    invNo.value = "";
    invRef.value = "";
    invLines = [ { kind:"item", desc:"", qty:"1", price:"", vat:"25" } ];
    renderInvoiceCustomer();
    renderInvoiceLines();
    updateInvoiceTotals();
  }

  function renderInvoiceCustomer(){
    if (!invCustomerBox) return;
    if (!invCustomerId){
      invCustomerBox.textContent = "Ingen kund vald.";
      return;
    }
    const c = state.customers?.[invCustomerId];
    if (!c){
      invCustomerBox.textContent = "Ingen kund vald.";
      invCustomerId = null;
      return;
    }
    invCustomerBox.innerHTML = `<div style="font-weight:800;">${escapeHtml(c.name||"(namn)")}</div>
      <div class="muted small">${escapeHtml(c.addr||"")}</div>
      <div class="muted small">${escapeHtml(c.email||"")}${c.orgnr?" ¬∑ "+escapeHtml(c.orgnr):""}</div>`;
  }

  function lineAmount(ln){
    if (ln.kind !== "item") return { net:0, vat:0, gross:0 };
    const qty = Math.max(0, parseMoney(ln.qty));
    const price = Math.max(0, parseMoney(ln.price));
    const vatRate = Math.max(0, parseMoney(ln.vat));
    const net = Math.round(qty * price * 100) / 100;
    const vat = Math.round(net * (vatRate/100) * 100) / 100;
    const gross = Math.round((net + vat) * 100) / 100;
    return { net, vat, gross };
  }

  function updateInvoiceTotals(){
    let net = 0, vat = 0;
    for (const ln of invLines){
      const a = lineAmount(ln);
      net += a.net;
      vat += a.vat;
    }
    net = Math.round(net*100)/100;
    vat = Math.round(vat*100)/100;
    // "√ñresavrundning" ‚Äì round to nearest 0.01 already; keep placeholder for future cash rounding.
    const gross = Math.round((net+vat)*100)/100;

    if (invTotal) invTotal.textContent = fmtSEK(gross) + " " + (state.company.currency || "SEK");
    if (invRounding) invRounding.textContent = fmtSEK(0);

    const ok = !!invCustomerId && invLines.some(l=>l.kind==="item" && lineAmount(l).net>0);
    if (btnInvSave) btnInvSave.disabled = !ok;
    if (btnInvPrint) btnInvPrint.disabled = !ok;
    if (btnInvToVoucher) btnInvToVoucher.disabled = !ok;
  }

  function renderInvoiceLines(){
    if (!invLinesTbody) return;
    invLinesTbody.innerHTML = "";
    invLines.forEach((ln, idx)=>{
      const tr = document.createElement("tr");

      const tdDesc = document.createElement("td");
      const inpDesc = document.createElement("input");
      inpDesc.value = ln.desc || "";
      inpDesc.placeholder = (ln.kind === "comment") ? "Kommentar‚Ä¶" : "Artikel / tj√§nst‚Ä¶";
      inpDesc.addEventListener("input", ()=>{ ln.desc = inpDesc.value; updateInvoiceTotals(); });
      tdDesc.appendChild(inpDesc);

      const tdQty = document.createElement("td"); tdQty.className = "right";
      const inpQty = document.createElement("input");
      inpQty.inputMode = "decimal";
      inpQty.value = ln.kind === "item" ? (ln.qty ?? "1") : "";
      inpQty.placeholder = ln.kind === "item" ? "1" : "‚Äì";
      inpQty.disabled = ln.kind !== "item";
      inpQty.addEventListener("input", ()=>{ ln.qty = inpQty.value; updateInvoiceTotals(); renderInvoiceLines(); });
      tdQty.appendChild(inpQty);

      const tdPrice = document.createElement("td"); tdPrice.className = "right";
      const inpPrice = document.createElement("input");
      inpPrice.inputMode = "decimal";
      inpPrice.value = ln.kind === "item" ? (ln.price ?? "") : "";
      inpPrice.placeholder = ln.kind === "item" ? "0" : "‚Äì";
      inpPrice.disabled = ln.kind !== "item";
      inpPrice.addEventListener("input", ()=>{ ln.price = inpPrice.value; updateInvoiceTotals(); renderInvoiceLines(); });
      tdPrice.appendChild(inpPrice);

      const tdVat = document.createElement("td"); tdVat.className = "right";
      const inpVat = document.createElement("input");
      inpVat.inputMode = "decimal";
      inpVat.value = ln.kind === "item" ? (ln.vat ?? "25") : "";
      inpVat.placeholder = ln.kind === "item" ? "25" : "‚Äì";
      inpVat.disabled = ln.kind !== "item";
      inpVat.addEventListener("input", ()=>{ ln.vat = inpVat.value; updateInvoiceTotals(); renderInvoiceLines(); });
      tdVat.appendChild(inpVat);

      const tdSum = document.createElement("td"); tdSum.className = "right";
      const a = lineAmount(ln);
      tdSum.textContent = ln.kind === "item" ? fmtSEK(a.gross) : "";

      const tdX = document.createElement("td");
      const bx = document.createElement("button");
      bx.className = "btn secondary";
      bx.textContent = "‚úï";
      bx.addEventListener("click", ()=>{
        invLines.splice(idx,1);
        if (invLines.length===0) invLines.push({ kind:"item", desc:"", qty:"1", price:"", vat:"25" });
        renderInvoiceLines();
        updateInvoiceTotals();
      });
      tdX.appendChild(bx);

      tr.appendChild(tdDesc);
      tr.appendChild(tdQty);
      tr.appendChild(tdPrice);
      tr.appendChild(tdVat);
      tr.appendChild(tdSum);
      tr.appendChild(tdX);
      invLinesTbody.appendChild(tr);
    });
  }

  function invoiceYearId(){
    const y = (invYearSelect && invYearSelect.value) || state.activeYearId;
    return y;
  }

  function saveInvoice(){
    const yearId = invoiceYearId();
    const date = invDate.value || todayISO();
    const due = invDue.value || addDays(date, (state.company.payDays||30));
    const no = (invNo.value || "").trim() || nextInvoiceNo(yearId);
    const ref = clampText(invRef.value || "");

    const lines = invLines.map(l => ({
      kind: l.kind,
      desc: clampText(l.desc || "", 200),
      qty: l.kind === "item" ? Math.round(parseMoney(l.qty)*100)/100 : 0,
      price: l.kind === "item" ? Math.round(parseMoney(l.price)*100)/100 : 0,
      vat: l.kind === "item" ? Math.round(parseMoney(l.vat)*100)/100 : 0
    }));

    const inv = {
      id: editingInvoiceId ?? crypto.randomUUID(),
      yearId,
      no,
      date,
      due,
      customerId: invCustomerId,
      ref,
      lines
    };

    const idx = (state.invoices||[]).findIndex(x=>x.id===inv.id);
    if (idx>=0) state.invoices[idx] = inv; else state.invoices.push(inv);
    state.invoices.sort((a,b)=> (a.yearId+a.no+a.date).localeCompare(b.yearId+b.no+b.date, "sv"));

    save();
    newInvoice();
    renderInvoices();
  }

  function invoiceTotals(inv){
    let net=0, vat=0;
    for (const l of (inv.lines||[])){
      if (l.kind !== "item") continue;
      const n = Math.round((Number(l.qty)||0) * (Number(l.price)||0) * 100)/100;
      const v = Math.round(n * ((Number(l.vat)||0)/100) * 100)/100;
      net += n; vat += v;
    }
    net = Math.round(net*100)/100;
    vat = Math.round(vat*100)/100;
    const gross = Math.round((net+vat)*100)/100;
    return { net, vat, gross };
  }

  function renderInvoices(){
    // keep year selectors in sync
    fillYearSelectors();
    if (invYearSelect) invYearSelect.value = invYearSelect.value || state.activeYearId;

    const yid = (invYearSelect && invYearSelect.value) || state.activeYearId;
    const list = (state.invoices||[]).filter(i=>i.yearId===yid).slice().sort((a,b)=> (a.no+a.date).localeCompare(b.no+b.date, "sv"));

    if (invoiceList){
      invoiceList.innerHTML = "";
      if (!list.length){
        invoiceList.innerHTML = `<div class="muted small">Inga fakturor i detta √•r √§nnu.</div>`;
      } else {
        list.forEach(inv=>{
          const c = state.customers?.[inv.customerId];
          const tot = invoiceTotals(inv);
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="top">
              <div>
                <div class="title">Faktura #${escapeHtml(inv.no)} ¬∑ ${escapeHtml(inv.date)} ¬∑ ${escapeHtml(c?.name || "(kund)")}</div>
                <div class="meta">F√∂rfaller ${escapeHtml(inv.due)} ¬∑ Totalt ${fmtSEK(tot.gross)} ${escapeHtml(state.company.currency||"SEK")}</div>
              </div>
              <div class="row">
                <button class="btn secondary" data-act="edit" data-id="${inv.id}">√ñppna</button>
                <button class="btn secondary" data-act="print" data-id="${inv.id}">Skriv ut</button>
                <button class="btn danger" data-act="del" data-id="${inv.id}">Ta bort</button>
              </div>
            </div>
          `;
          div.addEventListener("click", async (e)=>{
            const b = e.target.closest("button");
            if (!b) return;
            const id = b.dataset.id;
            const act = b.dataset.act;
            if (act==="edit") loadInvoiceToEditor(id);
            if (act==="print") printInvoice(id);
            if (act==="del") await deleteInvoice(id);
          });
          invoiceList.appendChild(div);
        });
      }
    }

    updateInvoiceTotals();
  }

  function loadInvoiceToEditor(id){
    const inv = (state.invoices||[]).find(x=>x.id===id);
    if (!inv) return;
    editingInvoiceId = inv.id;
    if (invYearSelect) invYearSelect.value = inv.yearId;
    invDate.value = inv.date;
    invDue.value = inv.due;
    invNo.value = inv.no;
    invRef.value = inv.ref || "";
    invCustomerId = inv.customerId || null;
    invLines = (inv.lines||[]).map(l => ({
      kind: l.kind || "item",
      desc: l.desc || "",
      qty: (l.kind==="item") ? String(l.qty ?? "1") : "",
      price: (l.kind==="item") ? String(l.price ?? "") : "",
      vat: (l.kind==="item") ? String(l.vat ?? "25") : ""
    }));
    if (!invLines.length) invLines = [ { kind:"item", desc:"", qty:"1", price:"", vat:"25" } ];
    renderInvoiceCustomer();
    renderInvoiceLines();
    updateInvoiceTotals();
  }

  async function deleteInvoice(id){
    if (!(await confirmAsync("Ta bort fakturan?"))) return;
    state.invoices = (state.invoices||[]).filter(i=>i.id!==id);
    save();
    renderInvoices();
  }

  function printInvoice(id){
    const inv = (state.invoices||[]).find(x=>x.id===id);
    if (!inv) return;
    const c = state.customers?.[inv.customerId] || {};
    const tot = invoiceTotals(inv);

    const rows = (inv.lines||[]).map(l=>{
      if (l.kind !== "item"){
        return `<tr><td colspan="5" style="padding:8px 0; color:#666;">${escapeHtml(l.desc||"")}</td></tr>`;
      }
      const net = Math.round((Number(l.qty)||0)*(Number(l.price)||0)*100)/100;
      const vat = Math.round(net*((Number(l.vat)||0)/100)*100)/100;
      const gross = Math.round((net+vat)*100)/100;
      return `<tr>
        <td>${escapeHtml(l.desc||"")}</td>
        <td style="text-align:right;">${(Number(l.qty)||0)}</td>
        <td style="text-align:right;">${fmtSEK(Number(l.price)||0)}</td>
        <td style="text-align:right;">${Number(l.vat)||0}%</td>
        <td style="text-align:right;">${fmtSEK(gross)}</td>
      </tr>`;
    }).join("");

    const html = `<!doctype html><html><head><meta charset="utf-8" />
      <title>Faktura ${escapeHtml(inv.no)}</title>
      <style>
        body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; padding:24px; color:#111; }
        h1{ margin:0 0 8px 0; }
        .muted{ color:#555; }
        .top{ display:flex; justify-content:space-between; gap:20px; flex-wrap:wrap; align-items:flex-start; }
        .seller{ text-align:right; min-width:260px; }
        .logo{ max-height:72px; max-width:260px; object-fit:contain; }
        .box{ border:1px solid #ddd; border-radius:12px; padding:12px; background:#fafafa; }
        table{ width:100%; border-collapse:collapse; margin-top:16px; }
        th,td{ border-bottom:1px solid #ddd; padding:8px 6px; }
        th{ text-align:left; }
        .sum{ margin-top:12px; display:flex; justify-content:flex-end; }
        .sum div{ min-width:300px; }
        .paygrid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px; }
        @media (max-width: 700px){ .paygrid{ grid-template-columns: 1fr; } .seller{ text-align:left; } }
        .kv{ display:flex; justify-content:space-between; gap:12px; }
        .footer{ margin-top:18px; font-size:12px; color:#555; white-space:pre-wrap; }
      </style></head><body>
      <div class="top">
        <div>
          ${state.company.logoDataUrl?`<img class="logo" alt="Logotyp" src="${state.company.logoDataUrl}">`:""}
          <h1>Faktura #${escapeHtml(inv.no)}</h1>
          <div class="muted">Fakturadatum: ${escapeHtml(inv.date)} ¬∑ F√∂rfallodatum: ${escapeHtml(inv.due)}</div>
          ${inv.ref?`<div class="muted">Referens: ${escapeHtml(inv.ref)}</div>`:""}
          ${state.company.invoiceNote?`<div class="muted" style="margin-top:6px;">${escapeHtml(state.company.invoiceNote)}</div>`:""}
        </div>
        <div class="seller">
          <div style="font-weight:800;">${escapeHtml(state.company.name||"")}</div>
          ${state.company.orgnr?`<div class="muted">Org.nr: ${escapeHtml(state.company.orgnr)}</div>`:""}
          ${state.company.vat?`<div class="muted">Momsreg.nr: ${escapeHtml(state.company.vat)}</div>`:""}
          ${[state.company.addr, [state.company.zip, state.company.city].filter(Boolean).join(" "), state.company.country].filter(x=>x&&String(x).trim()).map(x=>`<div class="muted">${escapeHtml(x)}</div>`).join("")}
          ${state.company.email?`<div class="muted">${escapeHtml(state.company.email)}</div>`:""}
          ${state.company.phone?`<div class="muted">${escapeHtml(state.company.phone)}</div>`:""}
          ${state.company.web?`<div class="muted">${escapeHtml(state.company.web)}</div>`:""}
        </div>
      </div>

      <div style="margin-top:18px;">
        <div class="muted">Kund</div>
        <div style="font-weight:800;">${escapeHtml(c.name||"")}</div>
        <div class="muted">${escapeHtml(c.addr||"")}</div>
        ${c.orgnr?`<div class="muted">Org.nr: ${escapeHtml(c.orgnr)}</div>`:""}
        ${c.email?`<div class="muted">${escapeHtml(c.email)}</div>`:""}
      </div>

      <table>
        <thead><tr><th>Rad</th><th style="text-align:right;">Antal</th><th style="text-align:right;">√Å-pris</th><th style="text-align:right;">Moms</th><th style="text-align:right;">Belopp</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>

      <div class="sum"><div>
        <div class="kv"><span>Summa exkl. moms</span><span>${fmtSEK(tot.net)} ${escapeHtml(state.company.currency||"SEK")}</span></div>
        <div class="kv"><span>Moms</span><span>${fmtSEK(tot.vat)} ${escapeHtml(state.company.currency||"SEK")}</span></div>
        <div class="kv" style="font-weight:900; font-size:18px;"><span>Att betala</span><span>${fmtSEK(tot.gross)} ${escapeHtml(state.company.currency||"SEK")}</span></div>
      </div></div>

      <div class="paygrid">
        <div class="box">
          <div style="font-weight:800; margin-bottom:6px;">Betalningsuppgifter</div>
          ${state.company.bankgiro?`<div class="kv"><span>Bankgiro</span><span>${escapeHtml(state.company.bankgiro)}</span></div>`:""}
          ${state.company.plusgiro?`<div class="kv"><span>Plusgiro</span><span>${escapeHtml(state.company.plusgiro)}</span></div>`:""}
          ${state.company.swishPhone?`<div class="kv"><span>Swish</span><span>${escapeHtml(state.company.swishPhone)}</span></div>`:""}
          ${state.company.bankAccountNo?`<div class="kv"><span>Bankkonto</span><span>${escapeHtml(state.company.bankAccountNo)}</span></div>`:""}
          ${state.company.iban?`<div class="kv"><span>IBAN</span><span>${escapeHtml(state.company.iban)}</span></div>`:""}
          ${state.company.swift?`<div class="kv"><span>SWIFT/BIC</span><span>${escapeHtml(state.company.swift)}</span></div>`:""}
          <div class="kv"><span>Referens/OCR</span><span>${escapeHtml(inv.no)}</span></div>
        </div>
        <div class="box">
          <div style="font-weight:800; margin-bottom:6px;">Villkor</div>
          <div class="kv"><span>F√∂rfallodatum</span><span>${escapeHtml(inv.due)}</span></div>
          <div class="kv"><span>Belopp</span><span>${fmtSEK(tot.gross)} ${escapeHtml(state.company.currency||"SEK")}</span></div>
          ${state.company.payDays?`<div class="muted" style="margin-top:6px;">Betalvillkor: ${escapeHtml(String(state.company.payDays))} dagar</div>`:""}
        </div>
      </div>

      ${state.company.invoiceFooter?`<div class="footer">${escapeHtml(state.company.invoiceFooter)}</div>`:""}

      <script>window.onload=()=>window.print();<\/script>

      </body></html>`;

    const w = window.open("", "_blank");
    if (!w) return showToast("Popup blockerad. Till√•t popup f√∂r att skriva ut.", 6000);
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function createVoucherFromInvoice(){
    // super-enkel bokning: 1510 Debet, 3001 Kredit (netto), 2611 Kredit (moms)
    if (!invCustomerId) return;
    const yearId = invoiceYearId();
    const date = invDate.value || todayISO();
    const no = nextVerno(yearId, "F");

    const tmp = {
      lines: invLines.map(l=>({kind:l.kind, qty:parseMoney(l.qty), price:parseMoney(l.price), vat:parseMoney(l.vat)}))
    };
    let net=0, vat=0;
    for (const l of tmp.lines){
      if (l.kind!=="item") continue;
      const n = Math.round((l.qty||0)*(l.price||0)*100)/100;
      const v = Math.round(n*((l.vat||0)/100)*100)/100;
      net += n; vat += v;
    }
    net = Math.round(net*100)/100;
    vat = Math.round(vat*100)/100;
    const gross = Math.round((net+vat)*100)/100;
    if (!(gross>0)) return;

    // ensure accounts exist
    if (!state.accounts["1510"]) state.accounts["1510"] = { name:"Kundfordringar", type:"asset" };
    if (!state.accounts["3001"]) state.accounts["3001"] = { name:"F√∂rs√§ljning", type:"income" };
    if (!state.accounts["2611"]) state.accounts["2611"] = { name:"Utg√•ende moms", type:"liability" };

    state.vouchers.push({
      id: crypto.randomUUID(),
      yearId,
      series: "F",
      no,
      date,
      text: clampText(`Faktura ${invNo.value||""}`.trim() || "Faktura"),
      regDate: todayISO(),
      sign: state.company.defaultSign || "",
      lines: [
        { account:"1510", text:"Faktura", amount: +gross },
        { account:"3001", text:"F√∂rs√§ljning", amount: -net },
        { account:"2611", text:"Moms", amount: -vat }
      ].filter(l=>Math.abs(l.amount)>0.00001)
    });

    state.vouchers.sort((a,b)=> (a.yearId+b.series+a.no+a.date).localeCompare(b.yearId+b.series+b.no+b.date, "sv"));
    save();
    showToast("Skapade verifikation (serie F). Kontrollera konton och moms innan du anv√§nder skarpt.", 6500);
  }

  function openCustomerDialog(){
    if (!customerDialog) return;
    custName.value = ""; custAddr.value = ""; custEmail.value = ""; custOrgnr.value = "";
    renderCustomerList();
    customerDialog.showModal();
  }

  function closeCustomerDialog(){
    if (!customerDialog) return;
    customerDialog.close();
  }

  function renderCustomerList(){
    if (!customerList) return;
    customerList.innerHTML = "";
    const keys = Object.keys(state.customers||{}).sort((a,b)=> (state.customers[a]?.name||"").localeCompare(state.customers[b]?.name||"", "sv"));
    if (!keys.length){
      customerList.innerHTML = `<div class="muted small">Inga kunder sparade √§n.</div>`;
      return;
    }
    keys.forEach(id=>{
      const c = state.customers[id];
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="title">${escapeHtml(c.name||"(namn)")}</div>
            <div class="meta">${escapeHtml(c.addr||"")}</div>
          </div>
          <div class="row">
            <button class="btn" data-pick="${id}">V√§lj</button>
            <button class="btn danger" data-del="${id}">Ta bort</button>
          </div>
        </div>`;
      div.addEventListener("click", async (e)=>{
        const b = e.target.closest("button");
        if (!b) return;
        if (b.dataset.pick){
          invCustomerId = b.dataset.pick;
          renderInvoiceCustomer();
          updateInvoiceTotals();
          closeCustomerDialog();
        }
        if (b.dataset.del){
          if (!(await confirmAsync("Ta bort kunden?"))) return;
          delete state.customers[b.dataset.del];
          if (invCustomerId === b.dataset.del) invCustomerId = null;
          save();
          renderCustomerList();
          renderInvoiceCustomer();
          updateInvoiceTotals();
        }
      });
      customerList.appendChild(div);
    });
  }

  function saveCustomerAndPick(){
    const name = (custName.value||"").trim();
    if (!name) return showToast("Ange kundnamn.", 3500);
    const c = {
      name,
      addr: (custAddr.value||"").trim(),
      email: (custEmail.value||"").trim(),
      orgnr: (custOrgnr.value||"").trim()
    };
    const id = crypto.randomUUID();
    if (!state.customers) state.customers = {};
    state.customers[id] = c;
    invCustomerId = id;
    save();
    renderInvoiceCustomer();
    updateInvoiceTotals();
    closeCustomerDialog();
  }
  // --- Customer registry (tab) ---
  function resetCustomerEditor(){
    if (custEditId) custEditId.value = "";
    if (custRegName) custRegName.value = "";
    if (custRegAddr) custRegAddr.value = "";
    if (custRegEmail) custRegEmail.value = "";
    if (custRegOrgnr) custRegOrgnr.value = "";
  }

  function loadCustomerToEditor(id){
    const c = state.customers?.[id];
    if (!c) return;
    if (custEditId) custEditId.value = id;
    if (custRegName) custRegName.value = c.name || "";
    if (custRegAddr) custRegAddr.value = c.addr || "";
    if (custRegEmail) custRegEmail.value = c.email || "";
    if (custRegOrgnr) custRegOrgnr.value = c.orgnr || "";
  }

  function saveCustomerFromRegistry(){
    const name = (custRegName?.value || "").trim();
    if (!name) return showToast("Ange kundnamn.", 3500);
    const c = {
      name,
      addr: (custRegAddr?.value || "").trim(),
      email: (custRegEmail?.value || "").trim(),
      orgnr: (custRegOrgnr?.value || "").trim()
    };
    const id = (custEditId?.value || "").trim() || crypto.randomUUID();
    state.customers = state.customers || {};
    state.customers[id] = c;
    save();
    // keep invoice editor in sync if it was the same customer
    if (invCustomerId === id) renderInvoiceCustomer();
    updateInvoiceTotals();
    renderCustomers();
    loadCustomerToEditor(id);
  }

  async function deleteCustomer(id){
    const used = (state.invoices||[]).some(inv => inv.customerId === id);
    const msg = used
      ? "Kunden anv√§nds i minst en faktura. Ta bort √§nd√•? (Fakturor kommer visa '(kund)')"
      : "Ta bort kunden?";
    if (!(await confirmAsync(msg))) return;

    delete state.customers[id];
    if (invCustomerId === id) invCustomerId = null;
    save();
    renderCustomers();
    renderInvoiceCustomer();
    updateInvoiceTotals();
    resetCustomerEditor();
  }

  function renderCustomers(){
    if (!customersList) return;
    const q = (custSearch?.value || "").trim().toLowerCase();
    const keys = Object.keys(state.customers||{})
      .sort((a,b)=> (state.customers[a]?.name||"").localeCompare(state.customers[b]?.name||"", "sv"));

    customersList.innerHTML = "";
    if (!keys.length){
      customersList.innerHTML = `<div class="muted small">Inga kunder sparade √§n.</div>`;
      return;
    }

    keys.forEach(id=>{
      const c = state.customers[id];
      const hay = `${c.name||""} ${c.addr||""} ${c.email||""} ${c.orgnr||""}`.toLowerCase();
      if (q && !hay.includes(q)) return;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="title">${escapeHtml(c.name||"(namn)")}</div>
            <div class="meta">${escapeHtml(c.addr||"")}</div>
            <div class="meta">${escapeHtml(c.email||"")}${c.orgnr?(" ¬∑ "+escapeHtml(c.orgnr)):""}</div>
          </div>
          <div class="row">
            <button class="btn secondary" data-act="edit" data-id="${id}">Redigera</button>
            <button class="btn danger" data-act="del" data-id="${id}">Ta bort</button>
          </div>
        </div>
      `;
      div.addEventListener("click", async (e)=>{
        const b = e.target.closest("button");
        if (!b) return;
        const act = b.dataset.act;
        const cid = b.dataset.id;
        if (act==="edit"){ loadCustomerToEditor(cid); }
        if (act==="del"){ await deleteCustomer(cid); }
      });
      customersList.appendChild(div);
    });
  }

  // --- Supplier registry (tab) ---
  function resetSupplierEditor(){
    if (supEditId) supEditId.value = "";
    if (supRegName) supRegName.value = "";
    if (supRegAddr) supRegAddr.value = "";
    if (supRegEmail) supRegEmail.value = "";
    if (supRegOrgnr) supRegOrgnr.value = "";
    if (supRegPayout) supRegPayout.value = "";
  }

  function loadSupplierToEditor(id){
    const s = state.suppliers?.[id];
    if (!s) return;
    if (supEditId) supEditId.value = id;
    if (supRegName) supRegName.value = s.name || "";
    if (supRegAddr) supRegAddr.value = s.addr || "";
    if (supRegEmail) supRegEmail.value = s.email || "";
    if (supRegOrgnr) supRegOrgnr.value = s.orgnr || "";
    if (supRegPayout) supRegPayout.value = s.payout || "";
  }

  function saveSupplierFromRegistry(){
    const name = (supRegName?.value || "").trim();
    if (!name) return showToast("Ange leverant√∂rsnamn.", 3500);
    const s = {
      name,
      addr: (supRegAddr?.value || "").trim(),
      email: (supRegEmail?.value || "").trim(),
      orgnr: (supRegOrgnr?.value || "").trim(),
      payout: (supRegPayout?.value || "").trim()
    };
    const id = (supEditId?.value || "").trim() || crypto.randomUUID();
    state.suppliers = state.suppliers || {};
    state.suppliers[id] = s;
    save();
    renderSuppliers();
    loadSupplierToEditor(id);
  }

  async function deleteSupplier(id){
    if (!(await confirmAsync("Ta bort leverant√∂ren?"))) return;
    delete state.suppliers[id];
    save();
    renderSuppliers();
    resetSupplierEditor();
  }

  function renderSuppliers(){
    if (!suppliersList) return;
    const q = (supSearch?.value || "").trim().toLowerCase();
    const keys = Object.keys(state.suppliers||{})
      .sort((a,b)=> (state.suppliers[a]?.name||"").localeCompare(state.suppliers[b]?.name||"", "sv"));

    suppliersList.innerHTML = "";
    if (!keys.length){
      suppliersList.innerHTML = `<div class="muted small">Inga leverant√∂rer sparade √§n.</div>`;
      return;
    }

    keys.forEach(id=>{
      const s = state.suppliers[id];
      const hay = `${s.name||""} ${s.addr||""} ${s.email||""} ${s.orgnr||""} ${s.payout||""}`.toLowerCase();
      if (q && !hay.includes(q)) return;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="title">${escapeHtml(s.name||"(namn)")}</div>
            <div class="meta">${escapeHtml(s.addr||"")}</div>
            <div class="meta">${escapeHtml(s.email||"")}${s.orgnr?(" ¬∑ "+escapeHtml(s.orgnr)):""}${s.payout?(" ¬∑ "+escapeHtml(s.payout)):""}</div>
          </div>
          <div class="row">
            <button class="btn secondary" data-act="edit" data-id="${id}">Redigera</button>
            <button class="btn danger" data-act="del" data-id="${id}">Ta bort</button>
          </div>
        </div>
      `;
      div.addEventListener("click", async (e)=>{
        const b = e.target.closest("button");
        if (!b) return;
        const act = b.dataset.act;
        const sid = b.dataset.id;
        if (act==="edit"){ loadSupplierToEditor(sid); }
        if (act==="del"){ await deleteSupplier(sid); }
      });
      suppliersList.appendChild(div);
    });
  }


  function wireInvoiceEvents(){
    if (btnInvNew) btnInvNew.addEventListener("click", newInvoice);
    if (btnInvClear) btnInvClear.addEventListener("click", async ()=>{ if (!(await confirmAsync("Rensa fakturan?"))) return; newInvoice(); });
    if (btnInvAddItem) btnInvAddItem.addEventListener("click", ()=>{ invLines.push({ kind: "item", desc: "", qty: "1", price: "", vat: "25" });
 renderInvoiceLines(); updateInvoiceTotals(); });
    if (btnInvAddComment) btnInvAddComment.addEventListener("click", ()=>{ invLines.push({kind:"comment", desc:""}); renderInvoiceLines(); updateInvoiceTotals(); });
    if (btnInvPickCustomer) btnInvPickCustomer.addEventListener("click", openCustomerDialog);
    if (btnInvSave) btnInvSave.addEventListener("click", saveInvoice);
    if (btnInvPrint) btnInvPrint.addEventListener("click", ()=>{
      // print current editor as a "draft" by saving temporarily in memory
      const tmpId = editingInvoiceId || "__draft__";
      const tmp = { id: tmpId, yearId: invoiceYearId(), no: (invNo.value||"").trim()||"Utkast", date: invDate.value||todayISO(), due: invDue.value||addDays(invDate.value||todayISO(), (state.company.payDays||30)), customerId: invCustomerId, ref: invRef.value||"", lines: invLines.map(l=>({kind:l.kind, desc:l.desc||"", qty:parseMoney(l.qty), price:parseMoney(l.price), vat:parseMoney(l.vat)})) };
      // temporarily render without storing
      const c = state.customers?.[tmp.customerId];
      if (!c) return showToast("V√§lj kund f√∂rst.", 3500);
      // reuse printInvoice by pushing temp into state briefly
      const exists = (state.invoices||[]).find(x=>x.id===tmpId);
      if (!exists){
        state.invoices = state.invoices || [];
        state.invoices.push(tmp);
        printInvoice(tmpId);
        state.invoices = state.invoices.filter(x=>x.id!==tmpId);
      } else {
        printInvoice(tmpId);
      }
    });
    if (btnInvToVoucher) btnInvToVoucher.addEventListener("click", async ()=>{ if (!(await confirmAsync("Skapa en verifikation f√∂r fakturan (serie F)?"))) return; createVoucherFromInvoice(); });
    if (btnInvRefresh) btnInvRefresh.addEventListener("click", renderInvoices);
    if (invYearSelect) invYearSelect.addEventListener("change", renderInvoices);

    if (btnCustomerClose) btnCustomerClose.addEventListener("click", closeCustomerDialog);
    if (btnCustomerSave) btnCustomerSave.addEventListener("click", saveCustomerAndPick);

    [invDate, invDue, invNo, invRef].filter(Boolean).forEach(el=> el.addEventListener("input", updateInvoiceTotals));
  }

// --- Voucher editor ---
  let currentLines = [];
  let voucherEditorReadOnly = false;
  let viewingVoucherId = null; // when viewing an existing voucher (read-only)

  function renderVouchers(){
    if (!voucherList) return;
    const yearId = (yearSelect && yearSelect.value) || state.activeYearId;
    const list = (state.vouchers || []).filter(v => (v.yearId || "") === yearId);
    list.sort((a,b)=>{
      const ad = (a.date || "");
      const bd = (b.date || "");
      if (ad !== bd) return ad.localeCompare(bd, "sv");
      const as = (a.series || "");
      const bs = (b.series || "");
      if (as !== bs) return as.localeCompare(bs, "sv");
      const an = Number(a.no);
      const bn = Number(b.no);
      if (Number.isFinite(an) && Number.isFinite(bn) && an !== bn) return an - bn;
      return String(a.no||"").localeCompare(String(b.no||""), "sv");
    });

    voucherList.innerHTML = "";
    if (!list.length){
      const empty = document.createElement("div");
      empty.className = "muted small";
      empty.textContent = "Inga verifikationer i detta √•r.";
      voucherList.appendChild(empty);
      return;
    }

    list.forEach(v=>{
      const div = document.createElement("div");
      div.className = "item";
      const title = `${(v.series||"")}${(v.no||"")} ¬∑ ${v.date || ""} ¬∑ ${(v.text||"").trim() || "(utan text)"}`;
      const meta = `Reg: ${v.regDate || ""}${v.sign ? " ¬∑ Sign: " + v.sign : ""}${v.correctionOf ? " ¬∑ R√§ttelse av: " + v.correctionOf : ""}`;
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="title">${escapeHtml(title)}</div>
            <div class="meta">${escapeHtml(meta)}</div>
          </div>
          <div class="row">
            <button type="button" class="btn secondary" data-act="open" data-id="${escapeAttr(v.id)}">√ñppna</button>
            <button type="button" class="btn danger" data-act="del" data-id="${escapeAttr(v.id)}">Ta bort</button>
          </div>
        </div>
      `;
      voucherList.appendChild(div);
    });
  }

  let voucherListWired = false;
  function wireVoucherEvents(){
    if (btnNewVoucher) btnNewVoucher.addEventListener("click", (e)=>{ e.preventDefault(); newVoucher(); });
    if (btnAddLine) btnAddLine.addEventListener("click", (e)=>{ e.preventDefault(); if (voucherEditorReadOnly) return; currentLines.push(makeLine()); renderLines(); updateBalanceBadge(); });
    if (btnClearVoucher) btnClearVoucher.addEventListener("click", async (e)=>{ e.preventDefault(); if (!(await confirmAsync("Rensa verifikationen?"))) return; newVoucher(); });
    if (btnSaveVoucher) btnSaveVoucher.addEventListener("click", (e)=>{ e.preventDefault(); saveVoucher(); });
    if (btnRefresh) btnRefresh.addEventListener("click", (e)=>{ e.preventDefault(); renderVouchers(); });

    if (btnFillExample) btnFillExample.addEventListener("click", async (e)=>{
      e.preventDefault();
      if (!(await confirmAsync("Skapa exempelverifikationer A76‚ÄìA79 i valt √•r?"))) return;
      const yearId = (yearSelect && yearSelect.value) || state.activeYearId;
      const date = todayISO();
      const cash = state.accounts["1930"] ? "1930" : (Object.keys(state.accounts)[0] || "");
      const other = state.accounts["4010"] ? "4010" : (Object.keys(state.accounts)[1] || cash || "");
      const defs = [
        { no:"76", text:"Exempel: k√∂p", amount: 1000 },
        { no:"77", text:"Exempel: f√∂rs√§ljning", amount: 1250 },
        { no:"78", text:"Exempel: avgift", amount: 99 },
        { no:"79", text:"Exempel: justering", amount: 250 },
      ];
      let added = 0;
      defs.forEach(d=>{
        const exists = (state.vouchers||[]).some(v=>v.yearId===yearId && (v.series||"")==="A" && String(v.no||"")===d.no);
        if (exists) return;
        const lines = [
          { account: other, text: d.text, amount: Math.round(d.amount*100)/100 },
          { account: cash, text: d.text, amount: -Math.round(d.amount*100)/100 },
        ];
        state.vouchers.push({
          id: crypto.randomUUID(),
          yearId,
          series: "A",
          no: d.no,
          date,
          text: d.text,
          regDate: date,
          sign: state.company.defaultSign || "",
          lines,
          correctionOf: null
        });
        added++;
      });
      save();
      renderVouchers();
      showToast(added ? `Skapade ${added} exempelverifikationer.` : "Exempelverifikationerna fanns redan.", 4500);
    });

    if (voucherList && !voucherListWired){
      voucherListWired = true;
      voucherList.addEventListener("click", async (e)=>{
        const b = e.target && e.target.closest ? e.target.closest("button[data-act]") : null;
        if (!b) return;
        const act = b.dataset.act;
        const id = b.dataset.id;
        if (!id) return;
        if (act === "open") viewVoucherToEditor(id);
        if (act === "del") await deleteVoucher(id);
        renderVouchers();
      });
    }
  }


  function newVoucher(){
    editingVoucherId = null;
    viewingVoucherId = null;
    voucherEditorReadOnly = false;
    correctionOfId = null;
    vDate.value = todayISO();
    vSeries.value = "A";
    vNo.value = "";
    vText.value = "";
    vSign.value = state.company.defaultSign || "";
    currentLines = [ makeLine(), makeLine() ];
    renderLines();
    updateBalanceBadge();
    if (btnSaveVoucher) btnSaveVoucher.disabled = true;
    updateFsUI();
  }

  function makeLine(){
    // default first account to 1930 if exists
    const defaultAcc = state.accounts["1930"] ? "1930" : Object.keys(state.accounts)[0] || "";
    return { account: defaultAcc, text: "", debit: "", credit: "" };
  }

  function renderLines(){
    linesTbody.innerHTML = "";
    const accList = Object.keys(state.accounts).sort((a,b)=>a.localeCompare(b,"sv"));

    currentLines.forEach((ln, idx) => {
      const tr = document.createElement("tr");

      // account select
      const tdAcc = document.createElement("td");
      const sel = document.createElement("select");
      sel.style.width = "100%";
      accList.forEach(no => {
        const opt = document.createElement("option");
        opt.value = no;
        opt.textContent = accountLabel(no);
        sel.appendChild(opt);
      });
      if (!state.accounts[ln.account] && ln.account) {
        // allow unknown
        const opt = document.createElement("option");
        opt.value = ln.account;
        opt.textContent = accountLabel(ln.account);
        sel.insertBefore(opt, sel.firstChild);
      }
      sel.value = ln.account;
      sel.disabled = voucherEditorReadOnly;
      sel.addEventListener("change", () => { ln.account = sel.value; updateBalanceBadge(); });
      tdAcc.appendChild(sel);

      // text
      const tdText = document.createElement("td");
      const inpText = document.createElement("input");
      inpText.value = ln.text;
      inpText.placeholder = "valfritt";
      inpText.disabled = voucherEditorReadOnly;
      inpText.addEventListener("input", () => ln.text = inpText.value);
      tdText.appendChild(inpText);

      // debit
      const tdD = document.createElement("td"); tdD.className = "right";
      const inpD = document.createElement("input");
      inpD.inputMode = "decimal";
      inpD.placeholder = "0";
      inpD.value = ln.debit;
      inpD.disabled = voucherEditorReadOnly;
      inpD.addEventListener("input", () => {
        ln.debit = inpD.value;
        if (parseMoney(ln.debit) !== 0) ln.credit = "";
        renderLines();
        updateBalanceBadge();
      });
      tdD.appendChild(inpD);

      // credit
      const tdC = document.createElement("td"); tdC.className = "right";
      const inpC = document.createElement("input");
      inpC.inputMode = "decimal";
      inpC.placeholder = "0";
      inpC.value = ln.credit;
      inpC.disabled = voucherEditorReadOnly;
      inpC.addEventListener("input", () => {
        ln.credit = inpC.value;
        if (parseMoney(ln.credit) !== 0) ln.debit = "";
        renderLines();
        updateBalanceBadge();
      });
      tdC.appendChild(inpC);

      // delete
      const tdX = document.createElement("td");
      const bx = document.createElement("button");
      bx.className = "btn secondary";
      bx.textContent = "‚úï";
      bx.title = "Ta bort rad";
      bx.disabled = voucherEditorReadOnly;
      bx.addEventListener("click", () => {
        currentLines.splice(idx, 1);
        if (currentLines.length === 0) currentLines.push(makeLine());
        renderLines();
        updateBalanceBadge();
      });
      tdX.appendChild(bx);

      tr.appendChild(tdAcc);
      tr.appendChild(tdText);
      tr.appendChild(tdD);
      tr.appendChild(tdC);
      tr.appendChild(tdX);
      linesTbody.appendChild(tr);
    });
  }

  function voucherTotals(){
    const deb = currentLines.reduce((s,ln)=> s + Math.max(0, parseMoney(ln.debit)), 0);
    const cre = currentLines.reduce((s,ln)=> s + Math.max(0, parseMoney(ln.credit)), 0);
    return { deb, cre, diff: deb - cre };
  }

  function updateBalanceBadge(){
    const { deb, cre, diff } = voucherTotals();
    const ok = Math.abs(diff) < 0.00001 && deb > 0;
    balanceBadge.className = "status " + (ok ? "ok" : "bad");
    balanceBadge.textContent = ok ? `I balans (${fmtSEK(deb)})` : `Diff: ${fmtSEK(diff)}`;
    btnSaveVoucher.disabled = voucherEditorReadOnly ? true : !ok;
  }

  function sanitizeVoucherLines(){
    // returns signed amounts: +debit, -credit
    return currentLines
      .map(ln => {
        const d = parseMoney(ln.debit);
        const c = parseMoney(ln.credit);
        const amount = d > 0 ? d : (c > 0 ? -c : 0);
        return {
          account: String(ln.account || "").trim(),
          text: clampText(ln.text || ""),
          amount: Math.round(amount * 100) / 100
        };
      })
      .filter(ln => ln.account && Math.abs(ln.amount) > 0.00001);
  }

  function getYear(id){ return state.fiscalYears.find(y => y.id === id); }


  function lockUntilForYear(yearId){
    const v = state.locks && state.locks[yearId];
    return (typeof v === "string" && v.length >= 10) ? v.slice(0,10) : "";
  }
  function isLockedVoucher(v){
    if (!v) return false;
    const until = lockUntilForYear(v.yearId || state.activeYearId);
    if (!until) return false;
    return (v.date || "") <= until;
  }
  function nextVerno(yearId, series){
    const seriesNorm = (series || "A").trim() || "A";
    const nums = state.vouchers
      .filter(v => v.yearId === yearId && (v.series || "") === seriesNorm)
      .map(v => Number(v.no))
      .filter(n => Number.isFinite(n));
    const max = nums.length ? Math.max(...nums) : 0;
    return String(max + 1);
  }

  function saveVoucher(){
    if (voucherEditorReadOnly) return showToast("Detta √§r en sparad verifikation i visningsl√§ge. Anv√§nd Korrigera f√∂r att skapa en r√§ttelseverifikation.", 6500);
    const yearId = yearSelect.value || state.activeYearId;
    const date = vDate.value || todayISO();
    if (editingVoucherId){
      const orig = state.vouchers.find(x=>x.id===editingVoucherId);
      if (orig && isLockedVoucher(orig)){
        showToast("Den h√§r verifikationen ligger i l√•st period och kan inte √§ndras. Skapa en r√§ttningsverifikation i st√§llet.", 6500);
        return;
      }
    }
    const series = (vSeries.value || "A").trim() || "A";
    const no = (vNo.value || "").trim() || nextVerno(yearId, series);
    const text = clampText(vText.value || "");
    const sign = clampText((vSign.value || state.company.defaultSign || "").trim());
    const regDate = todayISO();
    const lines = sanitizeVoucherLines();

    // Validate balancing
    const sum = lines.reduce((s,l)=> s + l.amount, 0);
    if (Math.abs(sum) > 0.00001){
      showToast("Verifikationen √§r inte i balans. Kontrollera debet/kredit.", 5000);
      return;
    }

    const v = {
      id: editingVoucherId ?? crypto.randomUUID(),
      yearId,
      series,
      no,
      date,
      text,
      regDate,
      sign,
      lines,
      correctionOf: correctionOfId || null
    };

    const idx = state.vouchers.findIndex(x => x.id === v.id);
    if (idx >= 0) state.vouchers[idx] = v;
    else state.vouchers.push(v);

    // Keep list sorted for nicer export
    state.vouchers.sort((a,b)=> (a.yearId+b.series+a.no+a.date).localeCompare(b.yearId+a.series+b.no+b.date, "sv"));
    save();
    newVoucher();
    renderVouchers();
  }

  function viewVoucherToEditor(id){
    const v = state.vouchers.find(x => x.id === id);
    if (!v) return;
    editingVoucherId = null;
    viewingVoucherId = v.id;
    voucherEditorReadOnly = true;
    if (isLockedVoucher(v)){
      showToast("Verifikationen ligger i l√•st period. Du kan inte √§ndra originalet ‚Äì jag skapar en r√§ttningsverifikation som h√§nvisar till den.", 6500);
      createCorrectionVoucher(v.id);
      return;
    }
    yearSelect.value = v.yearId;
    vDate.value = v.date;
    vSeries.value = v.series;
    vNo.value = v.no;
    vText.value = v.text;
    vSign.value = v.sign;

    currentLines = v.lines.map(l => ({
      account: l.account,
      text: l.text || "",
      debit: l.amount > 0 ? String(Math.abs(l.amount)).replace(".", ",") : "",
      credit: l.amount < 0 ? String(Math.abs(l.amount)).replace(".", ",") : ""
    }));
    if (currentLines.length === 0) currentLines = [makeLine(), makeLine()];
    renderLines();
    updateBalanceBadge();
  }

  async function deleteVoucher(id){
    const v = state.vouchers.find(x=>x.id===id);
    if (v && isLockedVoucher(v)) return showToast("Den h√§r verifikationen ligger i l√•st period och kan inte tas bort.", 6500);
    if (!(await confirmAsync("Ta bort verifikationen?"))) return;
    state.vouchers = state.vouchers.filter(v => v.id !== id);
    save();
    if (viewingVoucherId === id) newVoucher();
  }


  function createCorrectionVoucher(originalId){
    const orig = state.vouchers.find(x=>x.id===originalId);
    if (!orig) return;

    // Decide year for correction: default same year if today within it, else active year
    let targetYearId = orig.yearId || state.activeYearId;
    const fy = getYear(targetYearId);
    const t = todayISO();
    if (!fy || !(fy.start <= t && t <= fy.end)){
      targetYearId = state.activeYearId;
    }

    // Switch editor to target year
    if (yearSelect) yearSelect.value = targetYearId;
    state.activeYearId = targetYearId;

    editingVoucherId = null;
    correctionOfId = orig.id;

    vDate.value = (getYear(targetYearId) && getYear(targetYearId).start <= todayISO() && todayISO() <= getYear(targetYearId).end)
      ? todayISO()
      : (getYear(targetYearId)?.end || todayISO());

    vSeries.value = "R";
    vNo.value = "";
    vText.value = `R√§ttelse av ${orig.series || ""}${orig.no || ""} (${orig.date})`;
    vSign.value = state.company.defaultSign || "";

    // Reverse lines (storno)
    currentLines = (orig.lines || []).map(l => {
      const amt = Number(l.amount)||0;
      return {
        account: l.account,
        text: `R√§ttelse: ${(l.text||orig.text||"").slice(0,80)}`,
        debit: amt < 0 ? String(Math.abs(amt)).replace(".", ",") : "",
        credit: amt > 0 ? String(Math.abs(amt)).replace(".", ",") : ""
      };
    });

    if (!currentLines.length) currentLines = [ makeLine(), makeLine() ];

    // Go to vouchers tab + render
    activateTab("vouchers");

    renderLines();
    updateBalanceBadge();
    showToast("R√§ttningsverifikation skapad som utkast. Justera vid behov och spara.", 5500);
  }

  // --- Calculations / Reports ---
  function yearVouchers(yearId){
    return state.vouchers.filter(v => v.yearId === yearId);
  }

  function accountBalances(yearId){
    const bal = {}; // account -> signed balance (debit positive)
    yearVouchers(yearId).forEach(v => {
      v.lines.forEach(l => {
        bal[l.account] = (bal[l.account] || 0) + l.amount;
      });
    });
    // round
    Object.keys(bal).forEach(k => bal[k] = Math.round(bal[k]*100)/100);
    return bal;
  }

  function splitBSIS(bal){
    let assets = 0;
    let eqLiab = 0;
    let income = 0;
    let expense = 0;

    for (const [acc, amt] of Object.entries(bal)){
      const t = (state.accounts[acc]?.type) || guessTypeFromAccountNo(acc);
      if (t === "asset") assets += amt;
      else if (t === "liability") eqLiab += amt;
      else if (t === "income") income += amt; // typically negative
      else if (t === "expense") expense += amt; // typically positive
      else {
        // if unknown, try by BAS class
        const gt = guessTypeFromAccountNo(acc);
        if (gt === "asset") assets += amt;
        else if (gt === "liability") eqLiab += amt;
        else if (gt === "income") income += amt;
        else if (gt === "expense") expense += amt;
      }
    }

    // result: income + expense (income negative) => negative profit; we present profit positive
    const resultSigned = income + expense;
    const profit = -resultSigned;

    return { assets, eqLiab, income, expense, profit };
  }


  // --- Reports (generator) ---
  function pad2(n){ return String(n).padStart(2,"0"); }

  function isoIsValid(d){
    return typeof d === "string" && /^\d{4}-\d{2}-\d{2}$/.test(d);
  }

  function fiscalYearStart(yearId){
    const fy = getYear(yearId);
    if (fy && isoIsValid(fy.start)) return fy.start;
    return yearId + "-01-01";
  }
  function fiscalYearEnd(yearId){
    const fy = getYear(yearId);
    if (fy && isoIsValid(fy.end)) return fy.end;
    return yearId + "-12-31";
  }

  function clampRangeToFY(yearId, from, to){
    const a = fiscalYearStart(yearId);
    const b = fiscalYearEnd(yearId);
    let f = isoIsValid(from) ? from : a;
    let t = isoIsValid(to) ? to : b;
    if (f < a) f = a;
    if (t > b) t = b;
    if (t < f) t = f;
    return { from:f, to:t };
  }

  function vouchersInRange(yearId, from, to){
    return (state.vouchers||[])
      .filter(v => v.yearId === yearId && (!from || v.date >= from) && (!to || v.date <= to))
      .slice()
      .sort((a,b)=> (a.date+a.series+a.no).localeCompare(b.date+b.series+b.no, "sv"));
  }

  function balancesForVouchers(vs){
    const bal = {};
    for (const v of vs){
      for (const l of (v.lines||[])){
        bal[l.account] = (bal[l.account] || 0) + (Number(l.amount)||0);
      }
    }
    for (const k of Object.keys(bal)) bal[k] = Math.round(bal[k]*100)/100;
    return bal;
  }

  function balancesInRange(yearId, from, to){
    return balancesForVouchers(vouchersInRange(yearId, from, to));
  }

  function balancesAsOf(yearId, to){
    const start = fiscalYearStart(yearId);
    return balancesInRange(yearId, start, to);
  }

  function openingBalances(yearId, from){
    const start = fiscalYearStart(yearId);
    if (!from || from <= start) return {};
    const prev = addDays(from, -1);
    return balancesInRange(yearId, start, prev);
  }

  function reportMetaHtml(title, yearId, from, to){
    const fy = getYear(yearId);
    const rangeLabel = (from && to) ? `${from} ‚Äì ${to}` : (fy ? `${fy.start} ‚Äì ${fy.end}` : yearId);
    const gen = new Date().toLocaleString("sv-SE", { hour12:false });
    return `
      <div style="display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap; align-items:flex-end;">
        <div>
          <div style="font-size:18px; font-weight:900;">${escapeHtml(state.company.name || "FU-BOOKKEEPING")}</div>
          ${state.company.orgnr?`<div style="color:#555;">Org.nr: ${escapeHtml(state.company.orgnr)}</div>`:""}
        </div>
        <div style="text-align:right;">
          <div style="font-size:18px; font-weight:900;">${escapeHtml(title)}</div>
          <div style="color:#555;">Period: ${escapeHtml(rangeLabel)}</div>
          <div style="color:#555;">Genererad: ${escapeHtml(gen)}</div>
        </div>
      </div>
      <div style="height:1px; background:#ddd; margin:12px 0;"></div>
    `;
  }

  function buildTable(headers, rows){
    const th = headers.map(h=>`<th style="${h.style||""}">${escapeHtml(h.label||"")}</th>`).join("");
    const trs = rows.map(r=>{
      return "<tr>" + r.map((cell,i)=>{
        const style = headers[i]?.tdStyle || "";
        return `<td style="${style}">${cell}</td>`;
      }).join("") + "</tr>";
    }).join("");
    return `<table style="width:100%; border-collapse:collapse;">
      <thead><tr>${th}</tr></thead>
      <tbody>${trs}</tbody>
    </table>`;
  }

  function moneyCell(n){
    return `<span style="white-space:nowrap;">${fmtSEK(n)}</span>`;
  }

  function reportResultatrakning(yearId, from, to){
    const bal = balancesInRange(yearId, from, to);
    const rows = [];
    const rawRows = [];
    let rev = 0, cost = 0;

    const keys = Object.keys(bal).sort((a,b)=>a.localeCompare(b,"sv"));
    for (const acc of keys){
      const amt = bal[acc] || 0;
      const t = (state.accounts[acc]?.type) || guessTypeFromAccountNo(acc);
      if (t !== "income" && t !== "expense") continue;

      // Display as positive for income (credit) and as positive for expense (debit)
      const shown = (t === "income") ? -amt : amt;
      if (t === "income") rev += shown; else cost += shown;

      rows.push([
        escapeHtml(acc),
        escapeHtml(state.accounts[acc]?.name || ""),
        escapeHtml(t === "income" ? "Int√§kt" : "Kostnad"),
        `<div style="text-align:right;">${moneyCell(shown)}</div>`
      ]);
    }

    rev = Math.round(rev*100)/100;
    cost = Math.round(cost*100)/100;
    const profit = Math.round((rev - cost)*100)/100;

    const html = `
      ${reportMetaHtml("Resultatr√§kning", yearId, from, to)}
      <div style="display:flex; justify-content:flex-end; gap:24px; flex-wrap:wrap;">
        <div><div style="color:#555; font-size:12px;">Int√§kter</div><div style="font-weight:900; font-size:18px; text-align:right;">${fmtSEK(rev)}</div></div>
        <div><div style="color:#555; font-size:12px;">Kostnader</div><div style="font-weight:900; font-size:18px; text-align:right;">${fmtSEK(cost)}</div></div>
        <div><div style="color:#555; font-size:12px;">Resultat</div><div style="font-weight:900; font-size:18px; text-align:right;">${fmtSEK(profit)}</div></div>
      </div>
      <div style="margin-top:12px;"></div>
      ${buildTable(
        [
          {label:"Konto", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px; width:90px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Namn", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Typ", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px; width:90px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Belopp", style:"text-align:right; border-bottom:1px solid #ddd; padding:8px 6px; width:140px;", tdStyle:"border-bottom:1px solid #eee; padding:6px; text-align:right;"}
        ],
        rows.length?rows:[[`<span style="color:#666;">‚Äì</span>`, "", "", `<div style="text-align:right;">${moneyCell(0)}</div>`]]
      )}
      <div style="margin-top:10px; color:#555; font-size:12px;">Not: Belopp visar periodens summering. Int√§kter visas som positiva tal.</div>
    `;
    return { title:"Resultatr√§kning", html, columns:["Konto","Namn","Typ","Belopp"], rows: rawRows };
  }

  function reportBalansrakning(yearId, to){
    const bal = balancesAsOf(yearId, to);
    const assets = [];
    const liab = [];
    const rawRows = [];
    let sumA = 0, sumL = 0;

    const keys = Object.keys(bal).sort((a,b)=>a.localeCompare(b,"sv"));
    for (const acc of keys){
      const amt = bal[acc] || 0;
      const t = (state.accounts[acc]?.type) || guessTypeFromAccountNo(acc);
      if (t !== "asset" && t !== "liability") continue;

      if (t === "asset"){
        sumA += amt;
        assets.push([escapeHtml(acc), escapeHtml(state.accounts[acc]?.name||""), `<div style="text-align:right;">${moneyCell(amt)}</div>`]);
      } else {
        // liabilities/equity are typically negative in this app (credits). Show positive.
        const shown = -amt;
        sumL += shown;
        liab.push([escapeHtml(acc), escapeHtml(state.accounts[acc]?.name||""), `<div style="text-align:right;">${moneyCell(shown)}</div>`]);
      }
    }

    sumA = Math.round(sumA*100)/100;
    sumL = Math.round(sumL*100)/100;

    const html = `
      ${reportMetaHtml("Balansr√§kning", yearId, fiscalYearStart(yearId), to)}
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:18px;">
        <div>
          <div style="font-weight:900; margin-bottom:6px;">Tillg√•ngar</div>
          ${buildTable(
            [
              {label:"Konto", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px; width:90px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
              {label:"Namn", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
              {label:"Belopp", style:"text-align:right; border-bottom:1px solid #ddd; padding:8px 6px; width:140px;", tdStyle:"border-bottom:1px solid #eee; padding:6px; text-align:right;"}
            ],
            assets.length?assets:[[`<span style="color:#666;">‚Äì</span>`, "", `<div style="text-align:right;">${moneyCell(0)}</div>`]]
          )}
          <div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:900;">
            <div>Summa tillg√•ngar</div><div>${fmtSEK(sumA)}</div>
          </div>
        </div>
        <div>
          <div style="font-weight:900; margin-bottom:6px;">Eget kapital & skulder</div>
          ${buildTable(
            [
              {label:"Konto", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px; width:90px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
              {label:"Namn", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
              {label:"Belopp", style:"text-align:right; border-bottom:1px solid #ddd; padding:8px 6px; width:140px;", tdStyle:"border-bottom:1px solid #eee; padding:6px; text-align:right;"}
            ],
            liab.length?liab:[[`<span style="color:#666;">‚Äì</span>`, "", `<div style="text-align:right;">${moneyCell(0)}</div>`]]
          )}
          <div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:900;">
            <div>Summa EK/skulder</div><div>${fmtSEK(sumL)}</div>
          </div>
        </div>
      </div>
      <div style="margin-top:10px; color:#555; font-size:12px;">Not: EK/skulder visas som positiva tal (kredit-saldo).</div>
    `;
    return { title:"Balansr√§kning", html, columns:["Sektion","Konto","Namn","Belopp"], rows: rawRows };
  }

  function reportSaldolista(yearId, from, to){
    const period = balancesInRange(yearId, from, to);
    const asof = balancesAsOf(yearId, to);
    const keys = Array.from(new Set([...Object.keys(period), ...Object.keys(asof), ...Object.keys(state.accounts||{})]))
      .sort((a,b)=>a.localeCompare(b,"sv"));

    const rows = [];
    const rawRows = [];
    keys.forEach(acc=>{
      const p = Math.round((period[acc]||0)*100)/100;
      const a = Math.round((asof[acc]||0)*100)/100;
      if (Math.abs(p) < 0.00001 && Math.abs(a) < 0.00001) return;
      rows.push([
        escapeHtml(acc),
        escapeHtml(state.accounts[acc]?.name || ""),
        `<div style="text-align:right;">${moneyCell(p)}</div>`,
        `<div style="text-align:right;">${moneyCell(a)}</div>`
      ]);
    });

    const html = `
      ${reportMetaHtml("Saldolista", yearId, from, to)}
      ${buildTable(
        [
          {label:"Konto", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px; width:90px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Namn", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Period", style:"text-align:right; border-bottom:1px solid #ddd; padding:8px 6px; width:140px;", tdStyle:"border-bottom:1px solid #eee; padding:6px; text-align:right;"},
          {label:"Saldo per datum", style:"text-align:right; border-bottom:1px solid #ddd; padding:8px 6px; width:160px;", tdStyle:"border-bottom:1px solid #eee; padding:6px; text-align:right;"}
        ],
        rows.length?rows:[[`<span style="color:#666;">‚Äì</span>`, "", `<div style="text-align:right;">${moneyCell(0)}</div>`, `<div style="text-align:right;">${moneyCell(0)}</div>`]]
      )}
      <div style="margin-top:10px; color:#555; font-size:12px;">Belopp i appen visas med debet som + och kredit som ‚àí.</div>
    `;
    return { title:"Saldolista", html, columns:["Konto","Namn","Saldo"], rows: rawRows };
  }

  function reportVerJournal(yearId, from, to){
    const vs = vouchersInRange(yearId, from, to);
    const rows = [];
    const rawRows = [];
    vs.forEach(v=>{
      const deb = (v.lines||[]).reduce((s,l)=> s + (l.amount>0?l.amount:0), 0);
      const cre = (v.lines||[]).reduce((s,l)=> s + (l.amount<0?-l.amount:0), 0);
      rawRows.push([
        v.date,
        (v.series || "") + String(v.no || ""),
        v.text||"",
        v.sign||"",
        Math.round(deb*100)/100,
        Math.round(cre*100)/100
      ]);
      rows.push([
        escapeHtml(v.date),
        escapeHtml(v.series + v.no),
        escapeHtml(v.text||""),
        escapeHtml(v.sign||""),
        `<div style="text-align:right;">${moneyCell(deb)}</div>`,
        `<div style="text-align:right;">${moneyCell(cre)}</div>`
      ]);
    });

    const html = `
      ${reportMetaHtml("Verifikationsjournal", yearId, from, to)}
      ${buildTable(
        [
          {label:"Datum", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px; width:110px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Vernr", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px; width:90px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Text", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Sign", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px; width:70px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Debet", style:"text-align:right; border-bottom:1px solid #ddd; padding:8px 6px; width:140px;", tdStyle:"border-bottom:1px solid #eee; padding:6px; text-align:right;"},
          {label:"Kredit", style:"text-align:right; border-bottom:1px solid #ddd; padding:8px 6px; width:140px;", tdStyle:"border-bottom:1px solid #eee; padding:6px; text-align:right;"}
        ],
        rows.length?rows:[[`<span style="color:#666;">‚Äì</span>`, "", "", "", `<div style="text-align:right;">${moneyCell(0)}</div>`, `<div style="text-align:right;">${moneyCell(0)}</div>`]]
      )}
    `;
    return { title:"Verifikationsjournal", html, columns:["Datum","Vernr","Text","Sign","Debet","Kredit"], rows: rawRows };
  }

  function reportHuvudbok(yearId, from, to){
    const vs = vouchersInRange(yearId, from, to);
    const ob = openingBalances(yearId, from);
    const txByAcc = {};

    vs.forEach(v=>{
      (v.lines||[]).forEach(l=>{
        const acc = String(l.account||"");
        if (!txByAcc[acc]) txByAcc[acc] = [];
        txByAcc[acc].push({
          date: v.date, ver: (v.series||"")+String(v.no||""), text: l.text||v.text||"", amount: Number(l.amount)||0
        });
      });
    });

    const accs = Object.keys(txByAcc).sort((a,b)=>a.localeCompare(b,"sv"));

    let out = reportMetaHtml("Huvudbok", yearId, from, to);
    const rawRows = [];

    if (!accs.length){
      out += `<div style="color:#555;">Inga transaktioner i perioden.</div>`;
      return { title:"Huvudbok", html: out, columns:["Konto","Namn","Datum","Ver","Text","Belopp","Saldo"], rows: rawRows };
    }

    for (const acc of accs){
      const list = txByAcc[acc].slice().sort((a,b)=> (a.date+a.ver).localeCompare(b.date+b.ver,"sv"));
      let run = Math.round((ob[acc]||0)*100)/100;

      out += `<div style="margin-top:16px; font-weight:900;">${escapeHtml(acc)} ‚Äì ${escapeHtml(state.accounts[acc]?.name||"")}</div>`;
      out += `<div style="color:#555; font-size:12px; margin-bottom:6px;">Ing√•ende saldo (f√∂re ${escapeHtml(from)}): ${fmtSEK(run)}</div>`;

      const rows = [];
      list.forEach(t=>{
        run = Math.round((run + t.amount)*100)/100;
        rawRows.push([
          acc,
          (state.accounts[acc]?.name||""),
          t.date,
          t.ver,
          t.text,
          Math.round((t.amount||0)*100)/100,
          Math.round(run*100)/100
        ]);
        rows.push([
          escapeHtml(t.date),
          escapeHtml(t.ver),
          escapeHtml(t.text),
          `<div style="text-align:right;">${moneyCell(t.amount)}</div>`,
          `<div style="text-align:right;">${moneyCell(run)}</div>`
        ]);
      });

      out += buildTable(
        [
          {label:"Datum", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px; width:110px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Vernr", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px; width:90px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Text", style:"text-align:left; border-bottom:1px solid #ddd; padding:8px 6px;", tdStyle:"border-bottom:1px solid #eee; padding:6px;"},
          {label:"Belopp", style:"text-align:right; border-bottom:1px solid #ddd; padding:8px 6px; width:140px;", tdStyle:"border-bottom:1px solid #eee; padding:6px; text-align:right;"},
          {label:"Saldo", style:"text-align:right; border-bottom:1px solid #ddd; padding:8px 6px; width:140px;", tdStyle:"border-bottom:1px solid #eee; padding:6px; text-align:right;"}
        ],
        rows
      );
    }

    return { title:"Huvudbok", html: out };
  }

  function generateReport(){
    if (!reportOutput) return;
    const yearId = (rptYearSelect && rptYearSelect.value) ? rptYearSelect.value : state.activeYearId;
    const rawFrom = rptFrom ? rptFrom.value : "";
    const rawTo = rptTo ? rptTo.value : "";

    const { from, to } = clampRangeToFY(yearId, rawFrom, rawTo);
    if (rptFrom) rptFrom.value = from;
    if (rptTo) rptTo.value = to;

    const type = (rptType && rptType.value) ? rptType.value : "is";

    let rep;
    if (type === "is") rep = reportResultatrakning(yearId, from, to);
    else if (type === "bs") rep = reportBalansrakning(yearId, to);
    else if (type === "trial") rep = reportSaldolista(yearId, from, to);
    else if (type === "gl") rep = reportHuvudbok(yearId, from, to);
    else if (type === "vj") rep = reportVerJournal(yearId, from, to);
    else rep = reportResultatrakning(yearId, from, to);

    lastReportHtml = rep.html;
    lastReportTitle = rep.title;
    lastReportData = rep;

    reportOutput.innerHTML = rep.html;
    if (btnRptPrint) btnRptPrint.disabled = !rep.html;
    if (btnRptCsv) btnRptCsv.disabled = !(rep && Array.isArray(rep.rows) && rep.rows.length);
    if (btnRptXls) btnRptXls.disabled = !(rep && Array.isArray(rep.rows) && rep.rows.length);
  }

  function printLastReport(){
    if (!lastReportHtml) return;
    const title = lastReportTitle || "Rapport";
    const html = `<!doctype html><html><head><meta charset="utf-8">
      <title>${escapeHtml(title)}</title>
      <style>
        body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; padding:24px; color:#111; }
        table{ width:100%; border-collapse:collapse; }
        th,td{ border-bottom:1px solid #ddd; padding:8px 6px; vertical-align:top; }
        th{ background:#f7f7f7; }
        @media print{
          body{ padding:0; }
          th{ background:#f0f0f0 !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
        }
      </style>
      </head><body>
      ${lastReportHtml}
      <script>window.onload=()=>window.print();<\/script>
      </body></html>`;
    const w = window.open("", "_blank");
    if (!w) return showToast("Popup blockerad. Till√•t popup f√∂r att skriva ut.", 6000);
    w.document.open();
    w.document.write(html);
    w.document.close();
  }


  // --- Export last generated report (CSV / Excel) ---
  function csvEscape(val){
    const s = (val == null) ? "" : String(val);
    // Quote if contains separator, quote or newline
    if (/[;"\n\r]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
    return s;
  }

  function toCsvNumber(n){
    const v = Number(n);
    if (!Number.isFinite(v)) return "";
    // Swedish Excel often expects comma decimal with semicolon separator
    return v.toFixed(2).replace(".", ",");
  }

  function reportToCsv(columns, rows){
    const sep = ";";
    const out = [];
    out.push(columns.map(csvEscape).join(sep));
    for (const r of rows){
      const line = r.map(v => (typeof v === "number" ? toCsvNumber(v) : csvEscape(v))).join(sep);
      out.push(line);
    }
    return out.join("\n") + "\n";
  }

  function reportToXlsHtml(title, columns, rows){
    // Old-school HTML table served as .xls (works in Excel/LibreOffice)
    const th = columns.map(c => `<th>${escapeHtml(c)}</th>`).join("");
    const trs = rows.map(r => {
      const tds = r.map(v => {
        if (typeof v === "number") return `<td style="mso-number-format:'0.00'; text-align:right;">${escapeHtml(toCsvNumber(v).replace(",", "."))}</td>`;
        return `<td>${escapeHtml(v==null?"":String(v))}</td>`;
      }).join("");
      return `<tr>${tds}</tr>`;
    }).join("");
    return `<!doctype html><html><head><meta charset="utf-8">
      <title>${escapeHtml(title)}</title>
      <style>
        table{ border-collapse:collapse; }
        th,td{ border:1px solid #ccc; padding:6px 8px; vertical-align:top; }
        th{ background:#f7f7f7; font-weight:700; }
      </style>
      </head><body>
      <table>
        <thead><tr>${th}</tr></thead>
        <tbody>${trs}</tbody>
      </table>
      </body></html>`;
  }

  function safeFilename(s){
    return String(s||"rapport").replace(/[^a-z0-9\-_]+/gi,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"").slice(0,60) || "rapport";
  }

  function exportLastReport(kind){
    if (!lastReportData || !Array.isArray(lastReportData.columns) || !Array.isArray(lastReportData.rows)){
      return showToast("Ingen rapport att exportera √§nnu. Generera en rapport f√∂rst.", 4500);
    }
    const title = lastReportData.title || lastReportTitle || "Rapport";
    const base = safeFilename(title);
    if (kind === "csv"){
      const csv = reportToCsv(lastReportData.columns, lastReportData.rows);
      downloadText(base + ".csv", csv, "text/csv");
      return;
    }
    if (kind === "xls"){
      const xls = reportToXlsHtml(title, lastReportData.columns, lastReportData.rows);
      downloadText(base + ".xls", xls, "application/vnd.ms-excel");
      return;
    }
  }

  function setRangeFullYear(){
    const yearId = (rptYearSelect && rptYearSelect.value) ? rptYearSelect.value : state.activeYearId;
    if (rptFrom) rptFrom.value = fiscalYearStart(yearId);
    if (rptTo) rptTo.value = fiscalYearEnd(yearId);
  }

  function setRangeThisMonth(){
    const yearId = (rptYearSelect && rptYearSelect.value) ? rptYearSelect.value : state.activeYearId;
    const today = todayISO();
    const y = Number(today.slice(0,4));
    const m = Number(today.slice(5,7));
    const first = y + "-" + pad2(m) + "-01";
    const { from, to } = clampRangeToFY(yearId, first, today);
    if (rptFrom) rptFrom.value = from;
    if (rptTo) rptTo.value = to;
  }

  function setRangeThisQuarter(){
    const yearId = (rptYearSelect && rptYearSelect.value) ? rptYearSelect.value : state.activeYearId;
    const today = todayISO();
    const y = Number(today.slice(0,4));
    const m = Number(today.slice(5,7));
    const q = Math.floor((m-1)/3) + 1;
    const qm = (q-1)*3 + 1;
    const first = y + "-" + pad2(qm) + "-01";
    const { from, to } = clampRangeToFY(yearId, first, today);
    if (rptFrom) rptFrom.value = from;
    if (rptTo) rptTo.value = to;
  }

  function renderReports(){
    // Fill year selector and set sensible defaults
    fillYearSelectors();

    if (rptYearSelect){
      // Build options (reuse fiscal years)
      const ys = state.fiscalYears.slice().sort((a,b)=>a.id.localeCompare(b.id,"sv"));
      const prev = rptYearSelect.value;
      rptYearSelect.innerHTML = "";
      ys.forEach(y=>{
        const opt = document.createElement("option");
        opt.value = y.id;
        opt.textContent = `${y.id} (${y.start} ‚Äì ${y.end})`;
        rptYearSelect.appendChild(opt);
      });
      rptYearSelect.value = ys.find(y=>y.id===prev)?.id || state.activeYearId || ys[0]?.id || "";
    }

    // Default range: full FY
    if (rptFrom && rptTo){
      const yearId = (rptYearSelect && rptYearSelect.value) ? rptYearSelect.value : state.activeYearId;
      if (!rptFrom.value || !rptTo.value){
        rptFrom.value = fiscalYearStart(yearId);
        rptTo.value = fiscalYearEnd(yearId);
      }
    }

    // Keep print button in sync
    if (btnRptPrint) btnRptPrint.disabled = !lastReportHtml;
  }


  function renderLedger(yearId){
    if (!ledgerTbody || !ledgerAccount) return;
    const acc = ledgerAccount.value;
    if (!acc){ ledgerTbody.innerHTML = ""; return; }

    const vs = yearVouchers(yearId)
      .slice()
      .sort((a,b)=> (a.date+a.series+a.no).localeCompare(b.date+b.series+b.no, "sv"));

    const rows = [];
    vs.forEach(v=>{
      v.lines.forEach(l=>{
        if (String(l.account) !== String(acc)) return;
        rows.push({
          date: v.date,
          ver: (v.series||"") + (v.no||""),
          text: l.text || v.text || "",
          amt: Number(l.amount)||0
        });
      });
    });

    let run = 0;
    ledgerTbody.innerHTML = "";
    rows.forEach(r=>{
      run = Math.round((run + r.amt)*100)/100;
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.date)}</td>
        <td>${escapeHtml(r.ver)}</td>
        <td>${escapeHtml(r.text)}</td>
        <td class="right">${fmtSEK(r.amt)}</td>
        <td class="right">${fmtSEK(run)}</td>
      `;
      ledgerTbody.appendChild(tr);
    });

    if (rows.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="muted small">Inga transaktioner f√∂r valt konto i detta √•r.</td>`;
      ledgerTbody.appendChild(tr);
    }
  }


// --- Report generator wiring ---
if (btnRptGenerate) btnRptGenerate.addEventListener("click", generateReport);
if (btnRptPrint) btnRptPrint.addEventListener("click", printLastReport);
if (btnRptCsv) btnRptCsv.addEventListener("click", ()=> exportLastReport("csv"));
if (btnRptXls) btnRptXls.addEventListener("click", ()=> exportLastReport("xls"));
if (btnRptFullYear) btnRptFullYear.addEventListener("click", () => { setRangeFullYear(); });
if (btnRptThisMonth) btnRptThisMonth.addEventListener("click", () => { setRangeThisMonth(); });
if (btnRptThisQuarter) btnRptThisQuarter.addEventListener("click", () => { setRangeThisQuarter(); });

if (rptYearSelect){
  rptYearSelect.addEventListener("change", () => {
    setRangeFullYear();
    lastReportHtml = "";
    lastReportTitle = "";
    if (reportOutput) reportOutput.innerHTML = '<div class="muted small">V√§lj rapport + datumintervall och klicka <b>Generera</b>.</div>';
    if (btnRptPrint) btnRptPrint.disabled = true;
    if (btnRptCsv) btnRptCsv.disabled = true;
    if (btnRptXls) btnRptXls.disabled = true;
  });
}



  // --- Period lock wiring ---
  if (lockYear && lockUntil){
    lockYear.addEventListener("change", ()=>{ lockUntil.value = lockUntilForYear(lockYear.value); });
  }

  // --- Settings wiring ---
  if (btnSaveSettings){
    btnSaveSettings.addEventListener("click", (e)=>{
      e.preventDefault();
      try { saveSettings(); }
      catch(err){
        console.error(err);
        const msg = (err && (err.message || err.name)) ? String(err.message || err.name) : "(ok√§nt fel)";
        showToast(`Kunde inte spara inst√§llningar: ${msg}. Se konsolen.`, 8000);
      }
    });
  }

  if (btnRemoveLogo){
    btnRemoveLogo.addEventListener("click", (e)=>{
      e.preventDefault();
      state.company = state.company || defaultData().company;
      state.company.logoDataUrl = "";
      if (sLogo) sLogo.value = "";
      save();
      renderLogoPreview();
    });
  }

  if (sLogo){
    sLogo.addEventListener("change", ()=>{
      const f = sLogo.files && sLogo.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        state.company = state.company || defaultData().company;
        state.company.logoDataUrl = String(reader.result || "");
        save();
        renderLogoPreview();
      };
      reader.onerror = (err) => {
        console.error(err);
        showToast("Kunde inte l√§sa logotypfilen.", 6500);
      };
      reader.readAsDataURL(f);
    });
  }
  if (btnSetLock){
    btnSetLock.addEventListener("click", (e)=>{
      e.preventDefault();
      const yid = lockYear ? lockYear.value : state.activeYearId;
      if (!yid) return showToast("V√§lj √•r.", 3500);
      const until = (lockUntil?.value || "").trim();
      if (!until) return showToast("Ange ett datum att l√•sa t.o.m.", 4500);
      state.locks = state.locks || {};
      state.locks[yid] = until;
      save();
      showToast(`L√•st t.o.m ${until} f√∂r √•r ${yid}.`, 4500);
    });
  }
  if (btnClearLock){
    btnClearLock.addEventListener("click", (e)=>{
      e.preventDefault();
      const yid = lockYear ? lockYear.value : state.activeYearId;
      if (!yid) return;
      state.locks = state.locks || {};
      delete state.locks[yid];
      save();
      if (lockUntil) lockUntil.value = "";
      showToast(`Tog bort l√•s f√∂r √•r ${yid}.`, 4500);
    });
  }

// --- Init ---
try { fillYearSelectors(); } catch (e){ console.error(e); }

try { if (yearSelect) yearSelect.value = state.activeYearId; } catch (e){ console.error(e); }
try { if (vDate) vDate.value = todayISO(); } catch (e){ console.error(e); }

try { if (typeof newVoucher === "function") newVoucher(); } catch (e){ console.error(e); }

// Voucher wiring
try { if (typeof wireVoucherEvents === "function") wireVoucherEvents(); } catch (e){ console.error(e); }
try { if (typeof renderVouchers === "function") renderVouchers(); } catch (e){ console.error(e); }

// Accounts wiring
try { if (typeof wireAccountEvents === "function") wireAccountEvents(); } catch (e){ console.error(e); }

// Auto-repair already-saved corrupted kontonamn from standardlista (utan SIE)
try {
  if (typeof applyStdAccountsMapRepair === "function"){
    const r = applyStdAccountsMapRepair({ onlyReplacement: true });
    if (r && r.updated){
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e){ console.error(e); }
    }
  }
} catch (e){ console.error(e); }

try { if (typeof renderAccounts === "function") renderAccounts(); } catch (e){ console.error(e); }

// Invoices init
state.customers = state.customers || {};
state.suppliers = state.suppliers || {};
state.invoices = state.invoices || [];
state.features = state.features || { sruEnabled: false };

try { if (invYearSelect) invYearSelect.value = state.activeYearId; } catch (e){ console.error(e); }
try { if (invDate) invDate.value = todayISO(); } catch (e){ console.error(e); }
try { if (invDue) invDue.value = addDays(todayISO(), (state.company.payDays||30)); } catch (e){ console.error(e); }

try { if (typeof wireInvoiceEvents === "function") wireInvoiceEvents(); } catch (e){ console.error(e); }
try { if (typeof newInvoice === "function") newInvoice(); } catch (e){ console.error(e); }
try { if (typeof renderAll === "function") renderAll(); } catch (e){ console.error(e); }

// --- Import/Export wiring ---
if (btnExportJson) btnExportJson.addEventListener("click", (e)=>{ e.preventDefault(); exportBackupJson(); });
if (jsonImport) jsonImport.addEventListener("change", async (e)=>{
  const f = jsonImport.files && jsonImport.files[0];
  if (!f) return;
  try { await importBackupJsonFile(f); }
  catch(err){ console.error(err); showToast("Kunde inte importera JSON. Se konsolen.", 8000); }
  finally { jsonImport.value = ""; }
});
if (btnWipe) btnWipe.addEventListener("click", async (e)=>{ e.preventDefault(); await wipeAllData(); });

if (btnExportSie4) btnExportSie4.addEventListener("click", (e)=>{
  e.preventDefault();
  exportSie4((sieYearSelect && sieYearSelect.value) || state.activeYearId);
});
if (btnImportSie) btnImportSie.addEventListener("click", async (e)=>{
  e.preventDefault();
  const f = sieImportFile && sieImportFile.files && sieImportFile.files[0];
  try { await importSieFile(f, (sieImportEncoding && sieImportEncoding.value) || "utf-8", !!(sieImportWipe && sieImportWipe.checked)); }
  catch(err){ console.error(err); showToast("Kunde inte importera SIE. Se konsolen.", 8000); }
});

// --- File Sync wiring (UI moved to Settings) ---
if (btnConnectFile) btnConnectFile.addEventListener("click", async (e)=>{ e.preventDefault(); await fsConnectExisting(); });
if (btnCreateFile) btnCreateFile.addEventListener("click", async (e)=>{ e.preventDefault(); await fsCreateNew(); });
if (btnLoadFromFile) btnLoadFromFile.addEventListener("click", async (e)=>{
  e.preventDefault();
  try {
    await fsLoadState();
    fillYearSelectors();
    try { if (typeof renderAll === "function") renderAll(); } catch (e){ console.error(e); }
    showToast("Laddade data fr√•n fil.", 3500);
  }
  catch(err){ console.error(err); showToast("Kunde inte l√§sa fr√•n fil. Se konsolen.", 8000); }
});
if (btnSaveToFile) btnSaveToFile.addEventListener("click", async (e)=>{
  e.preventDefault();
  try { await fsWriteState(); showToast("Sparade till fil.", 3000); }
  catch(err){ console.error(err); showToast("Kunde inte spara till fil. Se konsolen.", 8000); }
});
if (btnDisconnectFile) btnDisconnectFile.addEventListener("click", async (e)=>{ e.preventDefault(); await fsDisconnect(); });

if (fsAutosave) fsAutosave.addEventListener("change", ()=>{ state.fileSync = state.fileSync || { autosave:true, requireFile:false }; state.fileSync.autosave = !!fsAutosave.checked; save(); updateFsUI(); });
if (fsRequireFile) fsRequireFile.addEventListener("change", ()=>{ state.fileSync = state.fileSync || { autosave:true, requireFile:false }; state.fileSync.requireFile = !!fsRequireFile.checked; save(); updateFsUI(); });

// Restore file handle if previously connected
idbGet("dataFileHandle").then(h=>{
  if (h){
    fsHandle = h;
    fsLastError = null;
    updateFsUI();
  }
}).catch(()=>{});
try { updateFsUI(); } catch (e){ /* ignore */ }


  // --- Arkivering ---
  if (btnMakeArchive){
    btnMakeArchive.addEventListener("click", async (e)=>{
      e.preventDefault();
      try { await makeArchive((archiveYearSelect && archiveYearSelect.value) || state.activeYearId); }
      catch(err){ console.error(err); showToast("Kunde inte skapa arkiv. Se konsolen f√∂r detaljer.", 8000); }
    });
  }
  if (btnVerifyArchive){
    btnVerifyArchive.addEventListener("click", async (e)=>{
      e.preventDefault();
      try { await verifyArchive(); }
      catch(err){ console.error(err); showToast("Kunde inte verifiera arkiv. Se konsolen f√∂r detaljer.", 8000); }
    });
  }

  // Capture fallback (if clicks are intercepted by overlays)
  document.addEventListener("click", (e)=>{
    const b1 = e.target && e.target.closest ? e.target.closest("#btnMakeArchive") : null;
    const b2 = e.target && e.target.closest ? e.target.closest("#btnVerifyArchive") : null;
    if (b1){
      e.preventDefault();
      makeArchive((archiveYearSelect && archiveYearSelect.value) || state.activeYearId);
    }
    if (b2){
      e.preventDefault();
      verifyArchive();
    }
  }, true);
})();
</script>
</body>
</html>